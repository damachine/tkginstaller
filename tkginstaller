#!/usr/bin/env bash
#shellcheck shell=bash
#set -euo pipefail
#IFS=$'\n\t'
#shopt -s nullglob globstar

# Maintainer: damachin3 (damachine3 at proton dot me)
# website: https://github.com/damachine/tkginstaller

# TKG-Installer VERSION definition
readonly _tkg_installer_version="v0.30.4"

# =============================================================================
# ENVIRONMENT SETUP
# =============================================================================

# Global variables, paths, and configurations
_tkg_tmp_dir=${HOME}/.tkginstaller/.cache
_tkg_choice_file=${_tkg_tmp_dir}/.choice.tmp
_local_config_dir=${HOME}/.config/frogminer
_tkg_repo_url=https://github.com/damachine/tkginstaller
_tkg_raw_url=https://raw.githubusercontent.com/damachine/tkginstaller/refs/heads/master/docs
_frog_repo_url=https://github.com/Frogging-Family
_frog_raw_url=https://raw.githubusercontent.com/Frogging-Family
_curl_opts="--max-time 10 --connect-timeout 5 -fsSL"

# Export only variables used in fzf preview commands
export _tkg_tmp_dir _local_config_dir _tkg_raw_url _frog_raw_url _curl_opts

# Git repository URL
declare -gA _frog_pkg_repo=(
    [linux]="${_frog_repo_url}/linux-tkg.git"
    [nvidia]="${_frog_repo_url}/nvidia-all.git"
    [mesa]="${_frog_repo_url}/mesa-git.git"
    [amdgpu]="${_frog_repo_url}/amdgpu-pro-vulkan-only.git"
    [amdvlk]="${_frog_repo_url}/amdvlk-opt.git"
    [wine]="${_frog_repo_url}/wine-tkg-git.git"
    [proton]="${_frog_repo_url}/wine-tkg-git.git"
    [dxvk]="${_frog_repo_url}/dxvk-tools.git"
    [gamescope]="${_frog_repo_url}/gamescope-git.git"
    [glibc]="${_frog_repo_url}/glibc-eac.git"
)

# Configuration file paths
declare -gA _frog_pkg_config=(
    [linux]="linux-tkg/master/customization.cfg"
    [nvidia]="nvidia-all/master/customization.cfg"
    [mesa]="mesa-git/master/customization.cfg"
    [amdgpu]="amdgpu-pro-vulkan-only/master/customization.cfg"
    [amdvlk]="amdvlk-opt/master/amdvlk-buildfromsource/customization.cfg"
    [wine]="wine-tkg-git/refs/heads/master/wine-tkg-git/customization.cfg"
    [proton]="wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg.cfg"
    [dxvk]="dxvk-tools/master/updxvk.cfg"
    [vkd3d]="dxvk-tools/master/upvkd3d-proton.cfg"
    [gamescope]="gamescope-git/master/customization.cfg"
)

# Optional: Subdirectory to enter after git clone
declare -gA _frog_pkg_workdir=(
    [amdvlk]="amdvlk-buildfromsource"
    [wine]="wine-tkg-git"
    [proton]="proton-tkg"
)

# Default build command for packages using __install_pkg_key
readonly _frog_pkg_cmd_default="makepkg -si"
# Only specify package-specific overrides here (leave empty if same as default)
declare -gA _frog_pkg_cmd=(
    # Example override:
    # [wine]="chmod +x non-makepkg-build.sh && ./non-makepkg-build.sh"
)

# Local config filenames
declare -gA _frog_pkg_local_config=(
    [linux]="linux-tkg.cfg"
    [nvidia]="nvidia-all.cfg"
    [mesa]="mesa-git.cfg"
    [amdgpu]="amdgpu-pro.cfg"
    [amdvlk]="amdvlk-opt.cfg"
    [wine]="wine-tkg.cfg"
    [proton]="proton-tkg.cfg"
    [dxvk]="updxvk.cfg"
    [vkd3d]="upvkd3d-proton.cfg"
    [gamescope]="gamescope.cfg"
)

# Normalize package argument to internal key
__normalize_package() {
    case "${1,,}" in
        linux | l) echo "linux" ;;
        nvidia | n) echo "nvidia" ;;
        mesa | m) echo "mesa" ;;
        amdgpu | ag) echo "amdgpu" ;;
        amdvlk | av) echo "amdvlk" ;;
        wine | w) echo "wine" ;;
        proton | p) echo "proton" ;;
        gamescope | g) echo "gamescope" ;;
        glibc | ge) echo "glibc" ;;
        *) echo "" ;;
    esac
}

# Check if argument is a config command
__is_config_arg() {
    [[ "${1,,}" =~ ^(config|c|edit|e|customize|cu)$ ]]
}

# Get full config URL for a package
__get_config_url() {
    local _pkg="$1"
    [[ -n "${_frog_pkg_config[${_pkg}]:-}" ]] && echo "${_frog_raw_url}/${_frog_pkg_config[${_pkg}]}"
}

# Initialize color and formatting
__init_style() {
    __clear_line() { printf '\r%*s\r\033[A' "$@"; }
    _break=$'\n'
    _reset=$'\033[0m'

    # Helper to return TrueColor escape if supported
    __color() {
        # $1 = r, $2 = g, $3 = b, $4 = fallback tput color index (0-7)
        local r=${1:-255} g=${2:-255} b=${3:-255} idx=${4:-7}

        # Detect basic TrueColor support
        if [[ "${COLORTERM,,}" == *truecolor* || "${COLORTERM,,}" == *24bit* ]]; then
            printf '\033[38;2;%d;%d;%dm' "$r" "$g" "$b"
            return 0
        fi

        # Fallback to tput
        if command -v tput >/dev/null 2>&1; then
            local _tput_seq
            _tput_seq=$(
                tput sgr0
                tput setaf "$idx"
            ) # Reset attributes, then set foreground color
            printf '%s' "${_tput_seq}"
            return 0
        fi

        # Fallback to 256-color approx idx: 1=red, 2=green, 3=yellow, 4=blue
        local _idx256
        case "$idx" in
            1) _idx256=196 ;; # bright red
            2) _idx256=118 ;; # light/bright green
            3) _idx256=214 ;; # orange/yellow
            4) _idx256=39 ;;  # bright blue/cyan-ish
            *) _idx256=15 ;;  # white
        esac
        printf '\033[38;5;%dm' "${_idx256}"
    }

    # Define TrueColor values, fallback to tput
    _red="$(__color 220 60 60 1)"          # warm red
    _green_light="$(__color 80 255 140 2)" # light green
    _green_neon="$(__color 120 255 100 2)" # neon green
    _green_mint="$(__color 152 255 200 6)" # mint green
    _green_dark="$(__color 34 68 34 2)"    # dark green (#224422)
    _orange="$(__color 255 190 60 3)"      # orange/yellow
    _gray="$(__color 200 250 200 7)"       # gray

    # Draw underline
    _uline_on=$(tput smul 2>/dev/null || printf '\033[4m')
    _uline_off=$(tput rmul 2>/dev/null || printf '\033[24m')

    # Calculate terminal width
    _cols="$(tput cols 2>/dev/null || echo 80)"
    local _line_len=$((_cols / 2))
    if [[ "${_line_len}" -lt 80 ]]; then
        _line_len=80
    fi
    _line=""
    for ((i = 0; i < "${_line_len}"; i++)); do _line+="‚îÄ"; done

    # Export only variables must be used in fzf preview commands to work properly
    export _break _reset _green_light _green_neon _green_mint _green_dark _orange _gray _uline_on _uline_off _cols _line
}

# Display banner
__banner() {
    local __color="${1:-${_green_neon}}"
    printf "%b\n" "${__color}"
    cat <<EOF
‚ñë‚ñÄ‚ñà‚ñÄ‚ñë‚ñà‚ñë‚ñà‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñÄ‚ñà‚ñÄ‚ñë‚ñà‚ñÄ‚ñà‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñà‚ñÄ‚ñë‚ñà‚ñÄ‚ñà‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñà‚ñÄ‚ñÑ
‚ñë‚ñë‚ñà‚ñë‚ñë‚ñà‚ñÄ‚ñÑ‚ñë‚ñà‚ñë‚ñà‚ñë‚ñÑ‚ñÑ‚ñÑ‚ñë‚ñë‚ñà‚ñë‚ñë‚ñà‚ñë‚ñà‚ñë‚ñÄ‚ñÄ‚ñà‚ñë‚ñë‚ñà‚ñë‚ñë‚ñà‚ñÄ‚ñà‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñà‚ñÄ‚ñÑ
‚ñë‚ñë‚ñÄ‚ñë‚ñë‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñë‚ñÄ‚ñë‚ñë‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ
‚îÄ‚îÄ  ${_tkg_installer_version}  ‚îÄ‚îÄ
EOF
    printf "%b\n" "${_reset}"
}

# =============================================================================
# INITIALIZATION AND PRE-CHECKS
# =============================================================================

# Initialize style and colors
__init_style

# Unified message function
__msg() {
    local _msg_first="${1:-}" _msg_level _msg
    if [[ "${_msg_first,,}" =~ ^(info_(green|orange|neon|mint|blue)|warning|error|prompt|plain)$ ]]; then
        _msg_level="${_msg_first,,}"
        shift
        _msg="$*"
    else
        _msg_level="plain"
        _msg="$*"
    fi

    # Ensure colors exist
    : "${_reset:=''}" "${_red:=''}" "${_green_light:=''}" "${_green_neon:=''}" "${_green_mint:=''}" "${_green_dark:=''}" "${_orange:=''}" "${_gray:=''}" "${_uline_on:=''}" "${_uline_off:=''}"

    # Map level
    local __color="" _prefix=""

    case "${_msg_level}" in
        prompt)
            printf '%b' "${_msg}"
            return 0
            ;;
        info_green)
            __color="${_green_light}"
            _prefix=""
            ;;
        info_neon)
            __color="${_green_neon}"
            _prefix=""
            ;;
        info_mint)
            __color="${_green_mint}"
            _prefix=""
            ;;
        info_orange)
            __color="${_orange}"
            _prefix=""
            ;;
        warning)
            __color="${_orange}"
            _prefix="${_uline_on}WARNING${_uline_off}:${__color} "
            ;;
        error)
            __color="${_red}"
            _prefix="${_uline_on}ERROR${_uline_off}:${__color} "
            ;;
        *)
            __color="${_reset}"
            _prefix=""
            ;;
    esac

    # Print formatted line with color and reset
    printf '%b\n' "${__color}${_prefix}${_msg}${_reset}"
}

# Message functions
__msg_info() { __msg 'info_green' "$@"; }
__msg_info_neon() { __msg 'info_neon' "$@"; }
__msg_info_mint() { __msg 'info_mint' "$@"; }
__msg_info_orange() { __msg 'info_orange' "$@"; }
__msg_warning() { __msg 'warning' "$@"; }
__msg_error() { __msg 'error' "$@"; }
__msg_prompt() { __msg 'prompt' "$@"; }
__msg_plain() { __msg 'plain' "$@"; }

# Display package information
__msg_pkg() {
    local _pkg_name="${1:-TKG package}"
    local _config_url="${2:-${_frog_repo_url}}"

    __msg_info "${_break}${_green_neon}${_uline_on}INFO${_uline_off}:${_reset} ${_green_light}Configuration Options for ${_pkg_name}${_reset}${_break}"
    __msg_plain " A wide range of options are available!"
    __msg_plain " TKG packages can be precisely tailored to your system.${_reset}${_break}"
    __msg_plain " Set up ${_gray}customization.cfg${_reset} using one of the following options:${_reset}${_break}"
    __msg_plain " ${_orange}A${_reset} ‚îÇ tkginstaller -> Config -> ${_pkg_name,,}${_reset}  ${_gray}(interactive)${_reset}"
    __msg_plain " ${_orange}B${_reset} ‚îÇ tkginstaller ${_pkg_name,,} config        ${_gray}(direct)${_reset}${_break}"
    __msg_plain " You will find detailed instructions at:${_reset}"
    __msg_plain " ${_gray}${_config_url}${_reset}"
}

# Check for root
if [[ "$(id -u)" -eq 0 ]]; then
    __banner "${_orange}"
    __msg_warning "You are running as root!${_break}"
    __msg_plain " Running this script as root is not recommended.${_break}"
    __msg_prompt "Do you really want to continue as root? [y/N]: "
    trap 'echo;echo; __msg_plain "${_red}Aborted by user.\n";sleep 1.5s; exit 1' INT
    read -r _user_answer
    trap - INT
    if [[ "${_user_answer}" =~ ^([yY]|[yY][eE][sS])$ ]]; then
        # User confirmed - continue
        :
    elif [[ "${_user_answer}" =~ ^([nN]|[nN][oO])$ ]]; then
        # Explicit no
        __msg_plain "${_break}${_red}Aborted by user.${_break}"
        exit 1
    else
        # Invalid input - treat as no (default)
        __msg_plain "${_break}${_orange}Invalid input. Defaulting to 'No'.${_break}"
        __msg_plain "${_red}Aborted.${_break}"
        exit 1
    fi
fi

# Detect Linux Distribution
if [[ -f /etc/os-release ]]; then
    # shellcheck disable=SC1091 # Source file is system-dependent and may not exist on all systems
    . /etc/os-release
    _distro_name="$NAME"
    _distro_id="${ID:-unknown}"
    _distro_like="${ID_LIKE:-}"
else
    _distro_name="Unknown"
    _distro_id="unknown"
    _distro_like=""
fi

# Check if distribution is Arch-based
if [[ "${_distro_id,,}" =~ ^(arch|cachyos|manjaro|endeavouros)$ || "${_distro_like,,}" == *"arch"* ]]; then
    _is_arch_based="true"
else
    _is_arch_based="false"
fi

# Help information display
__help() {
    __banner
    cat <<EOF
${_green_neon}${_uline_on}HELP${_uline_off}:${_reset} ${_green_light}TKG-Installer usage and commands${_reset}

${_green_neon}1) Interactive mode${_reset}
   Use fzf-based TUI mode:
   ${_gray}tkginstaller${_reset}

${_green_neon}2) Direct mode${_reset}
   Use direct CLI mode (skip TUI), run with arguments:
   ${_gray}tkginstaller [linux|l|nvidia|n|mesa|m|wine|w|proton|p|amdgpu|ag|amdvlk|av|gamescope|g|glibc|ge]${_reset}

${_green_neon}3) Config editing${_reset}
   Enter fzf-based TUI mode to edit a package's configuration:
   ${_gray}tkginstaller config${_reset}
   Edit a package's configuration file directly:
   ${_gray}tkginstaller [config|c|edit|e] [linux|l|nvidia|n|mesa|m|wine|w|proton|p|amdgpu|ag|amdvlk|av|gamescope|g|glibc|ge]${_reset}

${_green_neon}4) Clean temporary files${_reset}
   Remove all temporary files created during installations:
   ${_gray}tkginstaller clean${_reset}

${_orange}Shortcuts:${_reset} ${_orange}l${_reset}=linux, ${_orange}n${_reset}=nvidia, ${_orange}m${_reset}=mesa, ${_orange}ag${_reset}=amdgpu, ${_orange}av${_reset}=amdvlk, ${_orange}w${_reset}=wine, ${_orange}p${_reset}=proton, ${_orange}g${_reset}=gamescope, ${_orange}ge${_reset}=glibc-eac, ${_orange}c${_reset}=config, ${_orange}e${_reset}=edit

EOF
}

# Help can show always!
[[ $# -gt 0 && "${1:-}" =~ ^(help|h|--help|-h)$ ]] && {
    __help
    exit 0
}

# =============================================================================
# CORE UTILITY FUNCTIONS
# =============================================================================

# Safe directory change with error handling
__cd_safe() {
    local _target="$1"
    local _error_msg="${2:-Failed to enter directory: ${_target}}"
    cd "${_target}" || {
        __msg_error "${_error_msg}${_break}"
        return 1
    }
}

# Git clone with retry logic
__git_clone_retry() {
    local _repo_url="$1"
    local _target_dir="${2:-}"
    local _max_attempts="${3:-3}"
    local _attempt=0

    while ((_attempt < _max_attempts)); do
        if [[ -n "${_target_dir}" ]]; then
            git clone "${_repo_url}" "${_target_dir}" >/dev/null 2>&1 && return 0
        else
            git clone "${_repo_url}" >/dev/null 2>&1 && return 0
        fi
        _attempt=$((_attempt + 1))
        __msg_warning "Clone failed (attempt ${_attempt}/${_max_attempts}). Retrying in $((_attempt * 2))s..."
        sleep $((_attempt * 2))
    done
    return 1
}

# Build menu for installation method selection
# Sets _menu_choice global variable (not returned via echo due to subshell stdin issues)
# Usage: __build_menu "Package Name" "opt1_label" "opt1_desc" ["opt2_label" "opt2_desc" "opt9_label" "opt9_desc"]
__build_menu() {
    local _pkg_name="$1"
    local _opt1_label="${2:-makepkg -si}"
    local _opt1_desc="${3:-recommended for Arch}"
    local _opt2_label="${4:-}"
    local _opt2_desc="${5:-custom build script}"
    local _opt9_label="${6:-}"
    local _opt9_desc="${7:-}"

    # Calculate maximum label length for proper alignment
    local _max_label_length=0
    for _label in "${_opt1_label}" "${_opt2_label}" "${_opt9_label}"; do
        [[ -n "${_label}" ]] && ((${#_label} > _max_label_length)) && _max_label_length=${#_label}
    done

    __msg_info "${_break}${_green_neon}${_uline_on}CHOICE${_uline_off}:${_reset} ${_green_light}Which build method do you want to use?${_reset}${_break}"
    __msg_plain " Detected distro: ${_gray}${_distro_name}${_reset}${_break}"
    __msg_plain " ${_green_neon}${_uline_on}1${_uline_off}${_reset} ‚îÇ $(printf "%-${_max_label_length}s" "${_opt1_label}")  ${_green_light}${_opt1_desc}${_reset}"

    [[ -n "${_opt2_label}" ]] && __msg_plain " ${_orange}2${_reset} ‚îÇ $(printf "%-${_max_label_length}s" "${_opt2_label}")  ${_gray}${_opt2_desc}${_reset}"
    [[ -n "${_opt9_label}" ]] && __msg_plain " ${_gray}9${_reset} ‚îÇ $(printf "%-${_max_label_length}s" "${_opt9_label}")  ${_gray}${_opt9_desc}${_reset}"
    __msg_plain " ${_red}0${_reset} ‚îÇ Cancel${_break}"

    local _choices="[${_green_neon}${_uline_on}1${_uline_off}${_reset}"
    [[ -n "${_opt2_label}" ]] && _choices+="/${_orange}2${_reset}"
    [[ -n "${_opt9_label}" ]] && _choices+="/${_gray}9${_reset}"
    _choices+="/${_red}0${_reset}]"

    __prompt_timer "${_choices}" 60 1
    _menu_choice="${_user_answer}"
}

# Export associative array as newline-separated key=value for fzf preview
__export_map() {
    local -n _map_ref="$1"
    local _key
    for _key in "${!_map_ref[@]}"; do
        printf '%s=%s\n' "${_key}" "${_map_ref[${_key}]}"
    done
}

# Pre-installation checks
__prepare() {
    _load_preview="${1:-false}"

    # Welcome message
    __banner
    printf "%s" "${_green_neon}Starting"
    for _ in {1..3}; do
        printf " ."
        sleep 0.3s
    done
    printf "%b\n" "${_reset}"

    # Check required dependencies
    local _dep=(git onefetch)
    if [[ "${_load_preview}" == "true" ]]; then
        # Add optional dependencies
        _dep+=(bat curl glow fzf wdiff)
    fi

    # Define package names per distro
    declare -A _pkg_map_dep=(
        [git]=git
        [bat]=bat
        [curl]=curl
        [glow]=glow
        [fzf]=fzf
        [onefetch]=onefetch
        [wdiff]=wdiff
    )

    # Set install command based on distro
    case "${_distro_id,,}" in
        arch | manjaro | endeavouros | cachyos)
            _install_cmd_dep="pacman -S"
            ;;
        fedora)
            _install_cmd_dep="dnf install"
            ;;
        opensuse* | suse*)
            _install_cmd_dep="zypper install"
            ;;
        gentoo)
            # Gentoo uses category/package format
            declare -A _gentoo_categories=(
                [git]=dev-vcs
                [bat]=app-misc
                [curl]=net-misc
                [glow]=app-text
                [fzf]=app-misc
                [onefetch]=app-misc
                [wdiff]=app-text
            )
            for pkg in "${!_pkg_map_dep[@]}"; do
                _pkg_map_dep[$pkg]="${_gentoo_categories[$pkg]}/${pkg}"
            done
            _install_cmd_dep="emerge"
            ;;
        debian | ubuntu | linuxmint | pop | elementary | mx | raspbian)
            _install_cmd_dep="apt install"
            ;;
        *)
            _install_cmd_dep="your-package-manager install"
            ;;
    esac

    # Check for missing dependencies
    local _missing_dep=()
    for _required_dep in "${_dep[@]}"; do
        if ! command -v "${_required_dep}" >/dev/null 2>&1; then
            _missing_dep+=("${_required_dep}")
        fi
    done

    if [[ ${#_missing_dep[@]} -gt 0 ]]; then
        for i in {1..7}; do
            __clear_line 120 ""
        done
        __banner "${_red}"
        __msg_error "Missing dependencies detected.${_break}"
        __msg_plain " Please install the following dependencies first:${_break}"

        local _pkg_name_dep=()
        for _dependency in "${_missing_dep[@]}"; do
            _pkg_name_dep+=("${_pkg_map_dep[${_dependency}]:-${_dependency}}")
        done

        # Display installation command
        __msg_plain "${_install_cmd_dep} ${_pkg_name_dep[*]}${_break}"

        # Exit with error code
        exit 1 >/dev/null 2>&1
    fi

    # Setup temporary directory
    rm -f "${_tkg_choice_file}"
    # Cache is preserved to allow git pull updates instead of fresh clones
    mkdir -p "${_tkg_tmp_dir}" || {
        for i in {1..7}; do
            __clear_line 120 ""
        done
        __banner "${_red}"
        __msg_error "Creating temporary directory failed: ${_tkg_tmp_dir}${_break}"
        __msg_plain " Please check your permissions and try again.${_break}"
        exit 1 >/dev/null 2>&1
    }

    # Entering TKG-Installer
    if [[ "${_load_preview}" == "true" ]]; then
        __msg_plain "${_green_neon}Entering interactive menu${_reset}"
    else
        __msg_plain "${_green_neon}Running direct installation${_reset}"
    fi

    # Short delay for better UX
    sleep 0.5s
}

# Display completion status
__status() {
    local _status=${1:-$?}
    local _package_name="${2:-}"
    local _duration="${SECONDS:-0}"
    local _minutes=$((_duration / 60))
    local _seconds=$((_duration % 60))

    # Finisher message display
    __msg_info_orange "${_break}Action completed: $(date '+%Y-%m-%d %H:%M:%S')"
    if [[ ${_status} -eq 0 ]]; then
        if [[ -n "${_package_name}" ]]; then
            __msg_info "Status: ${_package_name} successfully completed!"
        else
            __msg_info "Status: Successfully completed!"
        fi
    else
        if [[ -n "${_package_name}" ]]; then
            __msg_error "Failed process: ${_package_name} (Code: ${_status})"
        else
            __msg_error "Failed process (Code: ${_status})"
        fi
    fi
    __msg_info_orange "Duration: ${_minutes} min ${_seconds} sec"
}

# Setup exit trap for cleanup on script termination and errors
__exit() {
    local _exit_code=${1:-$?}
    trap - INT TERM EXIT HUP

    # Message handling on exit with banner and status first
    if [[ ${_exit_code} -ne 0 ]]; then
        __banner "${_red}"

        # Show completion info for interrupted processes
        local _duration="${SECONDS:-0}"
        local _minutes=$((_duration / 60))
        local _seconds=$((_duration % 60))
        __msg_info_orange "${_break}Action completed: $(date '+%Y-%m-%d %H:%M:%S')"
        __msg_error "Failed process (Code: ${_exit_code})"
        __msg_info_orange "Duration: ${_minutes} min ${_seconds} sec${_break}"

        __msg_plain "${_red} Exiting due to errors. Please check the messages above for details.${_break}"
    else
        __banner
        __msg_plain "${_green_neon}Closed... Finish${_break}"
    fi

    # Perform cleanup
    __clean
    wait
    exit "${_exit_code}"
}

# Ensure signals lead to __exit with non-zero code so __exit shows error output.
trap 'trap - INT TERM EXIT HUP; __exit 130' INT TERM HUP
trap '__exit $?' EXIT

# Cleanup handler
__clean() {
    # Remove temporary files but preserve cache directory for git pull updates
    rm -f "${_tkg_choice_file}"

    # Unset all variables
    unset _tkg_tmp_dir _local_config_dir _tkg_raw_url _frog_raw_url _curl_opts
    unset _break _reset _green_light _green_neon _green_mint _green_dark _orange _gray _uline_on _uline_off _cols _line
}

# Clean temporary files and cache
__clean_temp_dir() {
    __banner
    __msg_info "Cleaning all temporary files...${_break}"
    __msg_plain " Location:${_reset}${_gray} ${_tkg_tmp_dir}${_reset}${_break}"
    local _cache_count=0
    local _cache_size_bytes=0
    local _cache_size_human=""

    if [[ -d "${_tkg_tmp_dir}" ]]; then
        _cache_count=$(find "${_tkg_tmp_dir}" -type f 2>/dev/null | wc -l || echo 0)
        _cache_size_bytes=$(du -sb "${_tkg_tmp_dir}" 2>/dev/null | cut -f1 || echo 0)
        _cache_size_human=$(du -sh "${_tkg_tmp_dir}" 2>/dev/null | cut -f1 || echo "0B")
    fi

    rm -f "${_tkg_choice_file}"
    rm -rf "${_tkg_tmp_dir}"
    sleep 1.5s

    if [[ "${_cache_count}" -eq 0 ]]; then
        __msg_plain "${_green_neon}Cleanup complete ${_gray}(nothing to remove, cache already clean)${_reset}${_break}"
    else
        __msg_plain "${_green_neon}Cleanup complete ${_gray}(${_orange}${_cache_count}${_reset} ${_gray}cached files removed, ${_orange}${_cache_size_human}${_reset}${_gray} freed)${_reset}${_break}"
    fi
}

# Fuzzy finder menu wrapper function
__fzf_menu() {
    # $1: Men√º-Inhalt, $2: Preview-Command, $3: Header, $4: Footer, $5: Label (optional), $6: Preview-Window-Settings (optional)
    local _menu_content="$1"
    local _preview_command="$2"
    local _header_text="$3"
    local _footer_text="$4"
    local _border_label_text="${5:-${_tkg_installer_version}}"
    local _preview_window_settings="${6:-right:wrap:55%}"
    local _fzf_bind="${7:-ctrl-p:toggle-preview}"

    # Run fzf with consistent styling and options
    fzf \
        --with-shell='bash -c' \
        --style default \
        --color='current-fg:#78FF64,current-bg:#224422,gutter:#224422,pointer:#224422,border:#224422,scrollbar:#224422:bold' \
        --border=sharp \
        --layout=reverse \
        --highlight-line \
        --height='-1' \
        --ansi \
        --delimiter='|' \
        --with-nth='2' \
        --gap='0' \
        --no-extended \
        --no-input \
        --no-multi \
        --no-multi-line \
        --cycle \
        --header="${_header_text}" \
        --header-border=line \
        --header-label="${_green_dark}${_border_label_text}" \
        --header-label-pos=2048 \
        --header-first \
        --footer="${_footer_text}" \
        --footer-border=line \
        --preview-window="${_preview_window_settings}" \
        --preview="${_preview_command}" \
        --preview-border=line \
        --bind='esc:abort,ctrl-c:abort' \
        --bind="${_fzf_bind}" \
        --disabled \
        <<<"${_menu_content}"
}

# =============================================================================
# INSTALLATION FUNCTIONS
# =============================================================================

# Generic package installation helper function
__install_package() {
    SECONDS=0
    local _repo_url="$1"
    local _package_name="$2"
    local _build_command="$3"
    local _work_directory="${4:-}"

    __cd_safe "${_tkg_tmp_dir}" || return 1

    local _repo_dir
    _repo_dir=$(basename "${_repo_url}" .git)

    # Clone or update repository
    if [[ -d "${_repo_dir}/.git" ]]; then
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Updating ${_gray}${_package_name}${_reset} ${_green_light}(git pull)...${_reset}${_break}"
        __cd_safe "${_repo_dir}" || return 1

        if ! git pull; then
            __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Git pull failed, trying fresh clone...${_reset}${_break}"
            __cd_safe "${_tkg_tmp_dir}" || return 1
            rm -rf "${_repo_dir}"
            __git_clone_retry "${_repo_url}" || {
                __msg_error "Cloning failed for: ${_package_name}${_break}"
                return 1
            }
        fi
        __cd_safe "${_tkg_tmp_dir}" || return 1
    else
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Cloning ${_gray}${_package_name}${_reset} ${_green_light}from Frogging-Family repository...${_reset}${_break}"

        # Handle existing directory without git metadata
        if [[ -d "${_repo_dir}" ]]; then
            __msg_warning "Found directory '${_repo_dir}' without git metadata"
            __msg_prompt "Remove and try fresh clone? [y/N]: "
            __prompt_answer "n"
            [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && rm -rf "${_repo_dir}" || return 1
        fi

        __git_clone_retry "${_repo_url}" || {
            __msg_error "Cloning failed for: ${_package_name}${_break}"
            return 1
        }
    fi

    __cd_safe "${_repo_dir}" || return 1
    [[ -n "${_work_directory}" ]] && { __cd_safe "${_work_directory}" || return 1; }

    # Display onefetch info
    if command -v onefetch >/dev/null 2>&1; then
        onefetch --no-bold --no-title --no-art --no-color-palette --http-url --email --nerd-fonts --text-colors 15 15 15 15 15 8 2>/dev/null | sed -u 's/^/ /'
        sleep 1.5s
    fi

    # Build and install
    __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building ${_gray}${_package_name}${_reset} ${_green_light}for ${_gray}${_distro_name}${_reset}${_orange}, this may take a while...${_reset}${_break}"
    eval "${_build_command}"
    local _status=$?

    __status "${_status}" "${_package_name}"
    return "${_status}"
}

# Generic package installation via registry
__install_pkg_key() {
    local _key="$1"
    local _repo="${_frog_pkg_repo[${_key}]}"
    local _name="${_key}"
    local _cmd="${_frog_pkg_cmd[${_key}]:-${_frog_pkg_cmd_default}}"
    local _workdir="${_frog_pkg_workdir[${_key}]:-}"
    local _config_url="${_frog_pkg_config[${_key}]:-}"

    # Inform user about external configuration if available
    if [[ -n "${_config_url}" ]]; then
        __msg_pkg "${_name}" "${_config_url}"
    fi

    # Execute installation process
    __install_package "${_repo}" "${_key}" "${_cmd}" "${_workdir}"
}

# Countdown prompt with timeout
__prompt_timer() {
    local _prompt_options="${1:-[1/2]}"
    local _timeout="${2:-60}"
    local _default="${3:-1}"
    local _old_trap_int=""

    _old_trap_int=$(trap -p INT 2>/dev/null)

    _seconds_left="${_timeout}"
    _user_answer=""
    local _abort_flag=false

    # Simple progress display
    while [[ ${_seconds_left} -gt 0 && ${_abort_flag} == false ]]; do
        # Set trap inside loop so break works correctly
        trap '__clear_line 120 ""; echo; echo; __msg_plain "${_red}Aborted by user!${_break}"; _abort_flag=true; break' INT

        # Display prompt
        printf "\r${_gray}%s ${_reset}  ${_orange}%02d${_gray}s ${_reset}  %s" \
            "${_prompt_options}" "${_seconds_left}"

        if read -r -t 1 -n 1 _key </dev/tty; then
            # If Enter pressed (no character), accept default immediately
            if [[ -z "${_key}" ]]; then
                _user_answer="${_default}"
                __clear_line 120 ""
                break
            fi
            # Accept only digit keys
            if [[ "${_key}" =~ ^[0-9]$ ]]; then
                _user_answer="${_key}"
                break
            else
                # Non-digit pressed
                continue
            fi
        fi
        ((_seconds_left--))
    done

    # Handle abort
    if [[ ${_abort_flag} == true ]]; then
        sleep 1.5s
        exit 130
    fi

    # Default if no answer
    : "${_user_answer:=${_default}}"

    # Normalize and sanitize user input
    _user_answer="${_user_answer//[[:space:]]/}"
    _user_answer="${_user_answer//[^0-9]/}"
    _user_answer="${_user_answer:0:1}"

    __clear_line 120 ""

    # Restore previous INT trap
    if [[ -n "${_old_trap_int}" ]]; then
        eval "${_old_trap_int}"
    else
        trap - INT
    fi
}

# Prompt user with default value
__prompt_answer() {
    local _default="${1:-n}"
    read -r _user_answer
    : "${_user_answer:=${_default}}"
}

# Linux-TKG installation
__linux_install() {
    __msg_pkg "Linux-TKG" "${_frog_repo_url}/linux-tkg/blob/master/customization.cfg"

    local _build_command

    if [[ "${_is_arch_based}" == "true" ]]; then
        __build_menu "Linux-TKG" \
            "makepkg -si" "recommended for Arch" \
            "install.sh install" "(generic script)" \
            "install.sh uninstall" "(show uninstall help)"

        case "${_menu_choice}" in
            0)
                __msg_info "${_break}${_orange}Cancelled by user${_reset}${_break}"
                __exit 1
                ;;
            2) _build_command="chmod +x install.sh && ./install.sh install" ;;
            9) _build_command="chmod +x install.sh && ./install.sh uninstall-help" ;;
            *) _build_command="makepkg -si" ;;
        esac
    else
        local _pkg_type=""
        case "${_distro_id,,}" in
            debian | ubuntu | linuxmint | pop | elementary | mx | raspbian) _pkg_type="DEB" ;;
            fedora | rhel | centos | rocky | alma | opensuse* | suse*) _pkg_type="RPM" ;;
        esac

        [[ -n "${_pkg_type}" ]] && __msg_info "${_break}${_green_neon}${_uline_on}INFO${_uline_off}:${_reset}${_green_light} ${_pkg_type}-based distribution detected: ${_gray}${_distro_name}${_reset}${_break}"
        _build_command="chmod +x install.sh && ./install.sh install"
    fi

    __install_package "${_frog_pkg_repo[linux]}" "linux-tkg" "${_build_command}"
    local _status=$?

    # Offer uninstall info for non-Arch distros after successful installation
    if [[ "${_is_arch_based}" != "true" && ${_status} -eq 0 ]]; then
        __msg_info "${_break}${_green_neon}${_uline_on}TIP${_uline_off}:${_reset}${_green_light} Uninstalling custom kernels has to be done manually.${_break}"
        __msg_prompt "Show uninstall info now? [y/N]: "
        read -r _show_info
        [[ "${_show_info,,}" =~ ^(y|yes)$ ]] && { cd "${_tkg_tmp_dir}/linux-tkg" && ./install.sh uninstall-help; }
    fi

    return "${_status:-0}"
}

# Simple package installers - direct delegation to __install_pkg_key
__nvidia_install() { __install_pkg_key "nvidia"; }
__mesa_install() { __install_pkg_key "mesa"; }
__amdgpu_pro_install() { __install_pkg_key "amdgpu"; }
__amdvlk_opt_install() { __install_pkg_key "amdvlk"; }
__gamescope_install() { __install_pkg_key "gamescope"; }

# Wine-TKG installation
__wine_install() {
    __msg_pkg "Wine-TKG" "${_frog_repo_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/customization.cfg"

    local _build_command

    if [[ "${_is_arch_based}" == "true" ]]; then
        __build_menu "Wine-TKG" \
            "makepkg -si" "recommended for Arch" \
            "non-makepkg-build.sh" "(custom build script)"

        case "${_menu_choice}" in
            0)
                __msg_info "${_break}${_orange}Cancelled by user${_reset}${_break}"
                __exit 1
                ;;
            2) _build_command="chmod +x non-makepkg-build.sh && ./non-makepkg-build.sh" ;;
            *) _build_command="makepkg -si" ;;
        esac
    else
        _build_command="chmod +x non-makepkg-build.sh && ./non-makepkg-build.sh"
    fi

    __install_package "${_frog_pkg_repo[wine]}" "wine-tkg-git" "${_build_command}" "${_frog_pkg_workdir[wine]}"
}

# glibc-eac installation
__glibc_install() {
    __build_menu "Glibc-eac" \
        "glibc_eac.sh" "recommended (Build & Install)" \
        "glibc_eac.sh build" "(Build only, no install)"

    local _build_command
    case "${_menu_choice}" in
        0)
            __msg_info "${_break}${_orange}Cancelled by user${_reset}${_break}"
            __exit 1
            ;;
        2) _build_command="chmod +x glibc_eac.sh && ./glibc_eac.sh build" ;;
        *) _build_command="chmod +x glibc_eac.sh && ./glibc_eac.sh" ;;
    esac

    __install_package "${_frog_pkg_repo[glibc]}" "glibc-eac" "${_build_command}"
}

# DXVK-Tools preparation (optional pre-build for Proton-TKG)
__dxvk_tools_prepare() {
    __msg_info "${_break}${_green_neon}${_uline_on}CHOICE${_uline_off}:${_reset} ${_green_light}Which DXVK/vkd3d build option do you want?${_reset}${_break}"
    __msg_plain " ${_orange}${_uline_on}0${_uline_off}${_reset} ‚îÇ No (skip)       ${_gray}Skip, continue with Proton-TKG${_reset}"
    __msg_plain " ${_green_neon}1${_reset} ‚îÇ Yes (both)      ${_green_light}Build DXVK + vkd3d-proton${_reset}"
    __msg_plain " ${_orange}2${_reset} ‚îÇ Custom          ${_gray}Choose individually${_reset}"
    __msg_plain " ${_red}9${_reset} ‚îÇ Cancel${_break}"

    __msg_info "${_green_neon}${_uline_on}NOTE${_uline_off}:${_reset} ${_green_light}Proton-TKG downloads official DXVK by default.${_reset}${_break}"
    __msg_plain " Set ${_gray}_use_dxvk=\"prebuilt\"${_reset} in ${_gray}proton-tkg.cfg${_reset} to use custom builds.${_break}"

    __prompt_timer "[${_orange}${_uline_on}0${_uline_off}${_reset}/${_green_neon}1${_reset}/${_orange}2${_reset}/${_red}9${_reset}]" 60 0

    local _build_dxvk=false _build_vkd3d=false _built_something=false

    case "${_user_answer}" in
        9)
            __msg_info "${_break}${_orange}Cancelled${_reset}${_break}"
            __exit 1
            ;;
        0)
            __msg_info "${_break}${_orange}Skipping DXVK/vkd3d${_reset}"
            return 0
            ;;
        2)
            __msg_prompt "${_break}Build DXVK? [y/N]: "
            __prompt_answer "n"
            [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && _build_dxvk=true
            __msg_prompt "Build vkd3d-proton? [y/N]: "
            __prompt_answer "n"
            [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && _build_vkd3d=true
            ;;
        *)
            _build_dxvk=true
            _build_vkd3d=true
            ;;
    esac

    # Nothing to build
    [[ "${_build_dxvk}" != "true" && "${_build_vkd3d}" != "true" ]] && return 0

    # Clone/prepare dxvk-tools
    local _dxvk_dir="${_tkg_tmp_dir}/dxvk-tools"
    if [[ ! -d "${_dxvk_dir}" ]]; then
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Cloning dxvk-tools...${_reset}${_break}"
        __git_clone_retry "${_frog_pkg_repo[dxvk]}" "${_dxvk_dir}" || {
            __msg_warning "Clone failed, skipping dxvk-tools${_break}"
            return 0
        }
    fi

    __cd_safe "${_dxvk_dir}" || return 0
    sleep 1s

    # Build selected components
    if [[ "${_build_dxvk}" == "true" ]]; then
        __msg_info "${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building DXVK...${_reset}${_break}"
        if ./updxvk build; then
            _built_something=true
        else
            __msg_warning "DXVK build failed${_break}"
        fi
    fi

    if [[ "${_build_vkd3d}" == "true" ]]; then
        __msg_info "${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building vkd3d-proton...${_reset}${_break}"
        if ./upvkd3d-proton build; then
            _built_something=true
        else
            __msg_warning "vkd3d build failed${_break}"
        fi
    fi

    # Export if something was built
    if [[ "${_built_something}" == "true" ]]; then
        __msg_prompt "${_break}Export for Proton-TKG? [y/N]: "
        __prompt_answer "n"
        [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && ./updxvk proton-tkg
    fi

    __cd_safe "${_tkg_tmp_dir}" || return 0
}

# Proton-TKG installation
__proton_install() {
    __msg_pkg "Proton-TKG" "${_frog_repo_url}/wine-tkg-git"

    # Prepare Proton repo first
    __install_package "${_frog_pkg_repo[proton]}" "Proton-TKG (prepare)" "" "${_frog_pkg_workdir[proton]}" >/dev/null 2>&1

    # Optional DXVK/vkd3d preparation
    __dxvk_tools_prepare || __msg_warning "dxvk-tools skipped${_break}"

    # Build Proton
    __install_package "${_frog_pkg_repo[proton]}" "Proton-TKG" "./proton-tkg.sh" "${_frog_pkg_workdir[proton]}"
    local _status=$?

    # Offer cleanup after successful build
    if [[ ${_status} -eq 0 ]]; then
        __msg_prompt "Run './proton-tkg.sh clean'? [y/N]: "
        read -r _user_answer
        [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] &&
            __install_package "${_frog_pkg_repo[proton]}" "Proton-TKG" "./proton-tkg.sh clean" "${_frog_pkg_workdir[proton]}"
    fi
}

# =============================================================================
# EDITOR MANAGEMENT FUNCTION
# =============================================================================

# Helper function to handle individual config file editing and downloading if missing
__error_config() {
    local _msg="$1"
    clear
    __banner "${_red}"
    __msg_error "${_msg}"
    __msg_prompt "Press any key to continue...${_break}"
    read -n 1 -s -r
    clear
}

# Text editor launcher
__editor() {
    local _target_file="${1}"
    local _editor_parts=()

    # Parse ${editor} variable and split into command + arguments
    if [[ -n "${EDITOR-}" ]]; then
        IFS=' ' read -r -a _editor_parts <<<"${EDITOR}"
    fi

    # Validate editor command exists, otherwise find fallback
    if [[ -z "${_editor_parts[0]:-}" ]] || ! command -v "${_editor_parts[0]}" >/dev/null 2>&1; then
        # Try common editors in order of preference
        for editor in nano micro vim vi; do
            if command -v "${editor}" >/dev/null 2>&1; then
                _editor_parts=("${editor}")
                break
            fi
        done

        # No editor found - show error
        if [[ -z "${_editor_parts[0]:-}" ]]; then
            __error_config "No editor found!${_break} Please set \${editor} environment variable or install one of:${_break} ${_gray}nano${_reset}, ${_gray}micro${_reset}, ${_gray}vim${_reset}, or ${_gray}vi${_reset}${_break}"
            return 1
        fi
    fi

    # Execute editor with target file
    "${_editor_parts[@]}" "${_target_file}"
}

# AMD Graphics Driver submenu
__menu_amd() {
    clear
    local _amd_menu_content="AMDGPU-PRO |üíé ${_green_neon}AMDGPU-PRO   ${_gray} AMD Vulkan-only (Pro)
AMDVLK-OPT |üî∑ ${_green_neon}AMDVLK-OPT   ${_gray} AMD Vulkan (buildfromsource)
return     |‚è™ ${_green_neon}Return"

    export _amd_repos_json="AMDGPU-PRO=amdgpu-pro-vulkan-only/master
AMDVLK-OPT=amdvlk-opt/master"

    # shellcheck disable=SC2016
    local _preview='key=$(echo {} | cut -d"|" -f1 | xargs)
[[ "$key" == "return" ]] && { echo "Back to main menu..."; exit 0; }
repo=$(echo "${_amd_repos_json}" | grep "^${key}=" | cut -d= -f2-)
[[ -n "$repo" ]] && glow --width 80 --style "'"${_glow_style:-dark}"'" "'"${_frog_raw_url}"'/${repo}/README.md"'

    local _header="üê∏ ${_green_neon}${_uline_on}TKG-Installer ‚îÄ AMD Drivers${_uline_off}${_reset}${_break}${_break}${_green_light}   Select AMD driver:"
    local _footer="  ${_green_light}[Enter] select, [Ctrl+P] preview, [ESC] exit"

    local _choice
    _choice=$(__fzf_menu "${_amd_menu_content}" "${_preview}" "${_header}" "${_footer}" "${_tkg_installer_version}" 'right:wrap:60%')
    unset _amd_repos_json

    [[ -z "${_choice}" ]] && return 0
    _choice=$(echo "${_choice}" | cut -d"|" -f1 | xargs)

    case ${_choice} in
        AMDGPU-PRO)
            __banner
            __amdgpu_pro_install
            ;;
        AMDVLK-OPT)
            __banner
            __amdvlk_opt_install
            ;;
    esac
}

# Configuration file editor menu
__menu_config() {
    while true; do
        local _config_choice

        # Ensure configuration directory exists
        if [[ ! -d "${_local_config_dir}" ]]; then
            __banner "${_orange}"
            __msg_warning "Configuration directory not found.${_break}"
            __msg_plain " Creating directory:${_reset}${_gray} ${_local_config_dir}${_reset}${_break}"
            __msg_prompt "Do you want to create the configuration directory? [y/N]: "

            local _old_trap_int=""
            _old_trap_int=$(trap -p INT 2>/dev/null)
            trap 'echo;echo; __msg_plain "${_red}Aborted by user.${_reset}";sleep 1.5; clear; return 0' INT
            __prompt_answer "n"
            if [[ -n "${_old_trap_int}" ]]; then eval "${_old_trap_int}"; else trap - INT; fi

            case "${_user_answer,,}" in
                y | yes)
                    if ! mkdir -p "${_local_config_dir}" 2>/dev/null; then
                        __error_config "Creating configuration directory failed: ${_local_config_dir}${_break} Please check the path and your permissions then try again.${_break}"
                        return 1
                    fi
                    clear
                    __banner
                    __msg_info "Configuration directory created:${_reset}${_gray} ${_local_config_dir}${_reset}${_break}"
                    __msg_plain " You can now manage your${_reset}${_gray} customization.cfg${_reset} files.${_break}"
                    __msg_prompt "Press any key to continue...${_break}"
                    read -n 1 -s -r
                    clear
                    continue
                    ;;
                *)
                    clear
                    __banner "${_orange}"
                    __msg_info_orange "Directory creation cancelled.${_break}"
                    __msg_plain " No changes were made.${_break}"
                    __msg_prompt "Press any key to continue...${_break}"
                    read -n 1 -s -r
                    clear
                    return 0
                    ;;
            esac
        fi

        # Build menu options dynamically
        local _menu_options=(
            "linux    |üêß ${_green_neon}Linux      ${_gray} customization.cfg ${_reset}->${_orange} 'linux-tkg.cfg'  "
        )

        # Add Nvidia and Mesa options only for Arch-based distros
        if [[ "${_is_arch_based}" == "true" ]]; then
            _menu_options+=(
                "nvidia   |üíª ${_green_neon}Nvidia     ${_gray} customization.cfg ${_reset}->${_orange} 'nvidia-all.cfg'"
                "mesa     |üß© ${_green_neon}Mesa       ${_gray} customization.cfg ${_reset}->${_orange} 'mesa-git.cfg'"
            )
        fi

        _menu_options+=(
            "wine      |üç∑ ${_green_neon}Wine       ${_gray} customization.cfg ${_reset}->${_orange} 'wine-tkg.cfg'"
            "proton    |üéÆ ${_green_neon}Proton     ${_gray} customization.cfg ${_reset}->${_orange} 'proton-tkg.cfg'"
            "dxvk      |üéÆ ${_green_neon}Dxvk       ${_gray} customization.cfg ${_reset}->${_orange} 'updxvk.cfg'"
            "vkd3d     |üéÆ ${_green_neon}Vkd3d      ${_gray} customization.cfg ${_reset}->${_orange} 'upvkd3d-proton.cfg'"
            "gamescope |üïπÔ∏è ${_green_neon}Gamescope  ${_gray} customization.cfg ${_reset}->${_orange} 'gamescope.cfg'"
            "return    |‚è™ ${_green_neon}Return"
        )

        # Prepare menu content
        local _menu_content
        _menu_content=$(printf '%s\n' "${_menu_options[@]}")

        # Export config URLs for preview command
        local _pkg_urls_json
        _pkg_urls_json=$(
            printf '%s\n' \
                "linux=${_frog_raw_url}/${_frog_pkg_config[linux]}" \
                "nvidia=${_frog_raw_url}/${_frog_pkg_config[nvidia]}" \
                "mesa=${_frog_raw_url}/${_frog_pkg_config[mesa]}" \
                "wine=${_frog_raw_url}/${_frog_pkg_config[wine]}" \
                "proton=${_frog_raw_url}/${_frog_pkg_config[proton]}" \
                "dxvk=${_frog_raw_url}/${_frog_pkg_config[dxvk]}" \
                "vkd3d=${_frog_raw_url}/${_frog_pkg_config[vkd3d]}" \
                "gamescope=${_frog_raw_url}/${_frog_pkg_config[gamescope]}"
        )
        export _pkg_urls_json

        # Export local config filenames for preview command
        local _pkg_local_cfg_json
        _pkg_local_cfg_json=$(
            printf '%s\n' \
                "linux=${_frog_pkg_local_config[linux]}" \
                "nvidia=${_frog_pkg_local_config[nvidia]}" \
                "mesa=${_frog_pkg_local_config[mesa]}" \
                "wine=${_frog_pkg_local_config[wine]}" \
                "proton=${_frog_pkg_local_config[proton]}" \
                "dxvk=${_frog_pkg_local_config[dxvk]}" \
                "vkd3d=${_frog_pkg_local_config[vkd3d]}" \
                "gamescope=${_frog_pkg_local_config[gamescope]}"
        )
        export _pkg_local_cfg_json

        # Define preview command components
        local _info_config="${_green_neon}Comparing remote and local ${_reset}${_gray}customization.cfg${_reset}${_green_neon}, press [Enter] to open and edit ${_reset}${_break}${_break}${_green_light} Remote:${_reset}${_gray} \${_remote_url} ${_reset}${_break}${_orange}‚â†${_reset}${_green_light} Local:${_reset}${_gray} file://\${_config_file_path} ${_reset}${_break}${_green_dark}${_line}${_break}"

        # Define error message for missing config file
        local _error_config_not_exist="${_orange}No external configuration file found.${_reset}${_break}${_break}${_green_light} This configuration file is required for customizing the -TKG- package.${_break}${_green_light} Press [Enter] to download the missing${_reset}${_gray} customization.cfg${_reset}${_green_light} file, according to -TKG- package standards.${_reset}${_break}${_green_dark}${_line}${_break}"

        # Define bat and wdiff commands for preview
        local _bat_cmd="bat --style=plain --language=cfg --wrap character --terminal-width ${_cols} --force-colorization --theme='Visual Studio Dark+'"
        local _diff_cmd="wdiff --terminal --statistics --start-delete='${_red}' --end-delete='${_reset}' --start-insert='${_green_light}' --end-insert='${_reset}'"

        # Simplified preview command using exported URLs
        # shellcheck disable=SC2016 # Need to use single quotes for fzf preview
        local _preview_command='
            key=$(echo {} | cut -d"|" -f1 | xargs)

            [[ "$key" == "return" ]] && { glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_tkg_raw_url}"'/return.md"; exit 0; }

            _local_cfg_name=$(echo "${_pkg_local_cfg_json}" | grep "^${key}=" | cut -d= -f2-)
            _config_file_path="'"${_local_config_dir}"'/${_local_cfg_name}"
            _remote_url=$(echo "${_pkg_urls_json}" | grep "^${key}=" | cut -d= -f2-)

            if [[ -f "${_config_file_path}" && -n "${_remote_url}" ]]; then
                _remote_tmp="'"${_tkg_tmp_dir}"'/${key}-remote.cfg"
                if curl '"${_curl_opts}"' "${_remote_url}" -o "${_remote_tmp}" 2>/dev/null; then
                    printf "%b\n" "'"${_info_config}"'"
                    '"${_diff_cmd}"' "${_remote_tmp}" "${_config_file_path}" 2>/dev/null | '"${_bat_cmd}"' || printf "%b\n" "${_orange}Diff failed${_reset}"
                    rm -f "${_remote_tmp}"
                else
                    printf "%b\n" "'"${_error_config_not_exist}"'"
                fi
            else
                printf "%b\n" "'"${_error_config_not_exist}"'"
            fi
        '

        # Define header texts
        local _header_text="üê∏ ${_green_neon}${_uline_on}TKG-Installer ‚îÄ Customizing (Beta)${_uline_off}${_reset}${_break}${_break}\
${_green_light}    - Customize to your preferred settings${_break}\
${_green_light}    - Download missing file(s)${_break}\
${_green_light}    - Show difference between remote and local${_break}${_break}\
${_green_light}    According to -TKG/Frogminer- package standards file(s)${_break}    stored in: ${_reset}${_gray}file://$HOME/.config/frogminer/${_reset}${_break}${_break}\
${_green_light}    Please make sure to adjust the settings correctly!${_break}    More visit: ${_reset}${_gray}https://github.com/Frogging-Family${_reset}${_break}${_break}${_break}\
${_green_light}   Select an option below:"

        # Define footer texts
        local _footer_text="  ${_green_light}Use arrow keys ‚å®Ô∏è or mouse üñ±Ô∏è to navigate${_break}\
  Press [Enter] to select, [Ctrl+P] ${_green_light}to toggle the preview window, [ESC] to exit${_break}${_break}\
  ${_green_light}Website:${_reset} ${_gray}https://github.com/damachine/tkginstaller${_reset} | ${_gray}https://github.com/Frogging-Family"

        # Define border label text
        local _border_label_text="${_tkg_installer_version}"
        local _preview_window_settings='right:wrap:75%'
        local _fzf_bind='ctrl-p:toggle-preview'

        # Run fzf menu
        local _config_choice
        _config_choice=$(__fzf_menu "${_menu_content}" "${_preview_command}" "${_header_text}" "${_footer_text}" "${_border_label_text}" "${_preview_window_settings}" "${_fzf_bind}")

        # Unset exported var _pkg_local_cfg_jsoniables
        unset _pkg_urls_json

        # Handle empty choice (ESC pressed)
        if [[ -z "${_config_choice}" ]]; then
            __banner
            __msg_info "${_green_neon}${_uline_on}APPLY${_uline_off}:${_reset}${_gray} customization.cfg${_reset}${_green_light} changes...${_break}"
            sleep 1.5s
            clear
            return 0
        fi

        # Extract config file key
        local _config_file
        _config_file=$(echo "${_config_choice}" | cut -d"|" -f1 | xargs)

        # Handle return option
        if [[ "${_config_file}" == "return" ]]; then
            __banner
            __msg_info "${_green_neon}${_uline_on}APPLY${_uline_off}:${_reset}${_gray} customization.cfg${_reset}${_green_light} changes...${_break}"
            sleep 1.5s
            clear
            return 0
        fi

        # Handle config editing using global package mappings
        if [[ -n "${_frog_pkg_config[${_config_file}]:-}" ]]; then
            __handle_config \
                "${_config_file}" \
                "${_local_config_dir}/${_frog_pkg_local_config[${_config_file}]}" \
                "$(__get_config_url "${_config_file}")"
        fi
    done
}

# Check local config against upstream for deprecated and new variables
__check_config() {
    local _config_file="$1" _upstream_url="$2" _package_name="$3"

    [[ ! -f "${_config_file}" ]] && return 0

    # Download upstream config
    local _tmp_upstream="/tmp/upstream_customization.cfg"
    curl -fsSL "${_upstream_url}" -o "${_tmp_upstream}" 2>/dev/null || {
        __msg_warning "Could not download upstream config for comparison"
        return 1
    }

    # Extract variable names from local and upstream configs
    local _local_vars _upstream_vars _upstream_vars_for_deprecated
    _local_vars=$(grep -oP '^#?\s*\K[_a-zA-Z][_a-zA-Z0-9]*(?==)' "${_config_file}" 2>/dev/null | sort -u)
    _upstream_vars=$(grep -oP '^#?\s*\K[_a-zA-Z][_a-zA-Z0-9]*(?==)' "${_tmp_upstream}" 2>/dev/null | sort -u)
    _upstream_vars_for_deprecated="${_upstream_vars}"

    # Fetch additional config files for extended variable detection
    local _extra_urls=()
    case "${_package_name}" in
        Linux-TKG)
            local _prepare_url="${_frog_raw_url}/linux-tkg/master/linux-tkg-config/prepare"
            local _tmp_prepare="/tmp/linux-tkg-prepare"
            if curl -fsSL "${_prepare_url}" -o "${_tmp_prepare}" 2>/dev/null; then
                # Extract officially deprecated vars (only for deprecated check)
                local _officially_deprecated
                _officially_deprecated=$(sed -n '/_deprecated_config_vars=($/,/^)$/p' "${_tmp_prepare}" | grep -oP '^\s*"_\K[^"]+' | sed 's/^/_/')
                [[ -n "${_officially_deprecated}" ]] && _upstream_vars_for_deprecated+=$'\n'"${_officially_deprecated}"

                # Extract prepare-specific variables only for deprecated check not for new
                local _prepare_vars
                _prepare_vars=$(grep -oP '^#?\s*\K[_a-zA-Z][_a-zA-Z0-9]*(?==)' "${_tmp_prepare}" 2>/dev/null)
                [[ -n "${_prepare_vars}" ]] && _upstream_vars_for_deprecated+=$'\n'"${_prepare_vars}"
                rm -f "${_tmp_prepare}"
            fi
            ;;
        Wine-TKG)
            _extra_urls=(
                "${_frog_raw_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/wine-tkg-profiles/advanced-customization.cfg"
                "${_frog_raw_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/wine-tkg-profiles/sample-external-config.cfg"
            )
            ;;
        Proton-TKG)
            _extra_urls=(
                "${_frog_raw_url}/wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg-profiles/advanced-customization.cfg"
                "${_frog_raw_url}/wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg-profiles/sample-external-config.cfg"
            )
            ;;
    esac

    # Fetch and merge extra config vars for both new and deprecated checks
    for _url in "${_extra_urls[@]}"; do
        local _tmp_extra="/tmp/extra_cfg_$$.cfg"
        if curl -fsSL "${_url}" -o "${_tmp_extra}" 2>/dev/null; then
            local _extra_vars
            _extra_vars=$(grep -oP '^#?\s*\K[_a-zA-Z][_a-zA-Z0-9]*(?==)' "${_tmp_extra}" 2>/dev/null)
            [[ -n "${_extra_vars}" ]] && {
                _upstream_vars+=$'\n'"${_extra_vars}"
                _upstream_vars_for_deprecated+=$'\n'"${_extra_vars}"
            }
            rm -f "${_tmp_extra}"
        fi
    done

    # Sort and deduplicate
    _upstream_vars=$(echo "${_upstream_vars}" | sort -u)
    _upstream_vars_for_deprecated=$(echo "${_upstream_vars_for_deprecated}" | sort -u)

    # Find deprecated variables
    local _deprecated_vars
    _deprecated_vars=$(comm -23 <(echo "${_local_vars}") <(echo "${_upstream_vars_for_deprecated}") 2>/dev/null)

    # Find new variables
    local _new_vars
    _new_vars=$(comm -13 <(echo "${_local_vars}") <(echo "${_upstream_vars}") 2>/dev/null)

    # Check if any changes detected
    local _has_changes=false
    [[ -n "${_deprecated_vars}" || -n "${_new_vars}" ]] && _has_changes=true

    # Display results if changes found
    if [[ "${_has_changes}" == "true" ]]; then
        __banner "${_orange}"
        __msg_info "${_green_neon}${_uline_on}CONFIG CHECK${_uline_off}:${_reset} ${_gray}${_config_file}${_reset}${_break}"

        # Show deprecated variables
        if [[ -n "${_deprecated_vars}" ]]; then
            __msg_warning "Deprecated variables (no longer used upstream):${_break}"
            while IFS= read -r _var; do
                [[ -n "${_var}" ]] && __msg_plain " ${_red}‚úó${_reset} ${_gray}${_var}${_reset}"
            done <<<"${_deprecated_vars}"
            echo
        fi

        # Show new variables
        if [[ -n "${_new_vars}" ]]; then
            __msg_info_neon "New variables available upstream:${_break}"
            while IFS= read -r _var; do
                [[ -n "${_var}" ]] && __msg_plain " ${_green_neon}+${_reset} ${_gray}${_var}${_reset}"
            done <<<"${_new_vars}"
            echo
        fi

        __msg_plain "${_green_light}${_uline_on}NOTE:${_uline_off} Review upstream config for details:${_reset}"
        __msg_plain " ${_gray}${_upstream_url}${_reset}"

        # Show additional config URLs for Wine and Proton
        for _url in "${_extra_urls[@]}"; do
            __msg_plain " ${_gray}${_url}${_reset}"
        done
        echo
        __msg_prompt "Press any key to continue..."
        read -n 1 -s -r
    fi

    rm -f "${_tmp_upstream}"
}

# Handle config file editing and downloading
__handle_config() {
    local _config_name="$1" _config_path="$2" _config_url="$3"

    # Check for deprecated and new variables
    [[ -f "${_config_path}" ]] && {
        __check_config "${_config_path}" "${_config_url}" "${_config_name}"
        clear
    }

    __banner
    __msg_info "${_green_neon}${_uline_on}OPEN${_uline_off}:${_reset}${_gray} ${_config_name}${_reset}${_green_light} configuration file${_break}"
    sleep 1s
    clear

    if [[ -f "${_config_path}" ]]; then
        __editor "${_config_path}" || return 1
    else
        # File doesn't exist - offer download
        __banner "${_orange}"
        __msg_warning "Configuration file does not exist.${_break}"
        __msg_plain " Local:  ${_gray}${_config_path}${_reset}"
        __msg_plain " Remote: ${_gray}${_config_url}${_reset}${_break}"
        __msg_prompt "Download default configuration? [y/N]: "
        __prompt_answer "n"

        if [[ "${_user_answer,,}" =~ ^(y|yes)$ ]]; then
            mkdir -p "$(dirname "${_config_path}")" || {
                __error_config "Failed to create directory"
                return 1
            }
            # shellcheck disable=SC2086
            if curl ${_curl_opts} "${_config_url}" -o "${_config_path}" 2>/dev/null; then
                clear
                __banner
                __msg_info "Configuration downloaded: ${_gray}${_config_path}${_reset}"
                sleep 1s
                clear
                __editor "${_config_path}" || return 1
            else
                __error_config "Download failed from ${_config_url}"
                return 1
            fi
        else
            clear
            __msg_info_orange "Download cancelled.${_break}"
            __msg_prompt "Press any key..."
            read -n 1 -s -r
            clear
            return 1
        fi
    fi

    __banner
    __msg_info "${_green_neon}${_uline_on}CLOSE${_uline_off}:${_reset}${_gray} ${_config_name}${_reset}${_green_light} configuration file${_break}"
    sleep 1s
    clear
}

# =============================================================================
# FZF MAIN MENU FUNCTIONS
# =============================================================================

# Interactive main menu
__menu() {
    # Glow style detection
    if [[ -z "${_glow_style:-}" ]]; then
        case "${COLORTERM:-}${TERM:-}" in
            *light* | *xterm* | *rxvt* | *konsole*)
                _glow_style="light"
                ;;
            *)
                _glow_style="dark"
                ;;
        esac
    fi

    # Define menu options
    local _menu_options=(
        "Linux     |üêß ${_green_neon}Linux      ${_gray} Linux custom kernels for better desktop and gaming experience"
    )

    if [[ "${_is_arch_based}" == "true" ]]; then
        _menu_options+=(
            "Nvidia      |üíª ${_green_neon}Nvidia     ${_gray} Nvidia open-source or proprietary graphics drivers"
            "Mesa        |üß© ${_green_neon}Mesa       ${_gray} AMD and Intel open-source graphics driver"
            "AMD         |üíé ${_green_neon}AMD        ${_gray} AMDGPU-PRO and Vulkan drivers (Pro & OPT)"
        )
    fi

    _menu_options+=(
        "Wine      |üç∑ ${_green_neon}Wine       ${_gray} Windows compatibility layer to run Windows apps on Linux"
        "Proton    |üéÆ ${_green_neon}Proton     ${_gray} Run Windows games on the Linux system via Steam"
        "Gamescope |üïπÔ∏è ${_green_neon}Gamescope  ${_gray} Build and install Gamescope from Frogging-Family"
        "Glibc     |üîó ${_green_neon}Glibc-eac  ${_gray} Install EAC compatible version of glibc"
        "Config    |üîß ${_green_neon}Config     ${_gray} Enter external configuration files menu (Expert)"
        "Clean     |üßπ ${_green_neon}Clean      ${_gray} Removes all temporary files for a clean installation"
        "Help      |‚ùì ${_green_neon}Help       ${_gray} Displays help and usage information about TKG-Installer"
        "Close     |‚ùé ${_green_neon}Close"
    )

    local _menu_content
    _menu_content=$(printf '%s\n' "${_menu_options[@]}")

    # Define preview mappings
    # Define preview mappings - docs and repos
    declare -A _preview_docs=(
        [Linux]=linux [Nvidia]=nvidia [Mesa]=mesa [AMD]=amd [Wine]=wine
        [Proton]=proton [Gamescope]=gamescope [Glibc]=glibc
        [Config]=config [Clean]=clean [Help]=help [Close]=close
    )
    declare -A _preview_repos=(
        [Linux]="linux-tkg/master" [Nvidia]="nvidia-all/master" [Mesa]="mesa-git/master"
        [Wine]="wine-tkg-git/master/wine-tkg-git" [Proton]="wine-tkg-git/master/proton-tkg"
        [Gamescope]="gamescope-git/master" [Glibc]="glibc-eac/main"
    )

    # Export preview mappings for fzf subshell (function __export_map is defined earlier)
    export _preview_docs_json _preview_repos_json
    # shellcheck disable=SC2218
    _preview_docs_json=$(__export_map _preview_docs)
    # shellcheck disable=SC2218
    _preview_repos_json=$(__export_map _preview_repos)

    # Simplified preview command using exported mappings
    # shellcheck disable=SC2016 # Need to use single quotes for fzf preview
    local _preview_command='
        key=$(echo {} | cut -d"|" -f1 | xargs)

        # Get doc path
        doc=$(echo "${_preview_docs_json}" | grep "^${key}=" | cut -d= -f2-)

        # Show local doc
        [[ -n "$doc" ]] && glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_tkg_raw_url}"'/${doc}.md"

        # Show remote README if package has repo
        repo=$(echo "${_preview_repos_json}" | grep "^${key}=" | cut -d= -f2-)
        [[ -n "$repo" ]] && glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_frog_raw_url}"'/${repo}/README.md"
    '
    # Define header texts
    local _header_text="üê∏ ${_green_neon}${_uline_on}TKG-Installer ‚îÄ Main${_uline_off}${_reset}${_break}${_break}\
    ${_green_light}- Build, install and customize -TKG/Frogminer- packages${_break}\
${_green_light}    - Manual in the preview window on the right${_break}${_break}${_break}\
${_green_light}   Select an option below:"

    # Define footer texts
    local _footer_text="  ${_green_light}Use arrow keys ‚å®Ô∏è or mouse üñ±Ô∏è to navigate${_break}\
  Press [Enter] to select, [Ctrl+P] ${_green_light}to toggle the preview window, [ESC] to exit${_break}${_break}\
  ${_green_light}Website:${_reset} ${_gray}https://github.com/damachine/tkginstaller${_reset} | ${_gray}https://github.com/Frogging-Family${_reset}"

    # Define border label text
    local _border_label_text="${_tkg_installer_version}"
    local _preview_window_settings='right:wrap:55%'
    local _fzf_bind='ctrl-p:toggle-preview'

    # Run fzf menu
    local _main_choice
    _main_choice=$(__fzf_menu "${_menu_content}" "${_preview_command}" "${_header_text}" "${_footer_text}" "${_border_label_text}" "${_preview_window_settings}" "${_fzf_bind}")

    # Cleanup exported variables
    unset _preview_docs_json _preview_repos_json

    # Handle user choice
    if [[ -z "${_main_choice:-}" ]]; then
        clear
        __exit 0
    fi

    # Write user choice to file
    echo "${_main_choice}" | cut -d"|" -f1 | xargs >"${_tkg_choice_file}"
}

# =============================================================================
# MAIN PROGRAM ENTRY POINT
# =============================================================================

# Handle direct command-line arguments
__main_direct_mode() {
    local _arg1="${1:-}"
    _arg1="${_arg1,,}"
    local _arg2="${2:-}"
    _arg2="${_arg2,,}"

    # Accept both [package] [config] and [config] [package] order for arguments
    local _package=""
    local _config_arg=""

    # Check for config argument using helper functions
    if __is_config_arg "${_arg1}"; then
        _config_arg="${_arg1}"
        _package=$(__normalize_package "${_arg2}")
    elif __is_config_arg "${_arg2}"; then
        _config_arg="${_arg2}"
        _package=$(__normalize_package "${_arg1}")
    fi

    # Allow only supported second-args (config/edit/customize)
    if [[ "${_arg1}" =~ ^(linux|l|nvidia|n|mesa|m|wine|w|proton|p)$ ]] && [[ -n "${_arg2}" ]] &&
        ! [[ "${_arg2}" =~ ^(config|c|edit|e|customize|cu)$ ]]; then
        __banner "${_orange}"
        __msg_warning "Invalid argument:${_reset}${_gray} ${_arg1:-} ${_arg2:-}${_reset}${_break}"
        __msg_plain " The argument is either invalid or incomplete."
        __msg_plain " All available arguments run:${_break}"
        __msg_plain "$0 help${_break}"
        trap - INT TERM EXIT HUP
        __clean
        exit 1
    fi

    # If user asked only "config" (no package) -> open interactive config menu
    if [[ -n "${_config_arg}" && -z "${_package}" ]]; then
        # Prepare environment and open config menu in interactive mode (with preview)
        trap - INT TERM EXIT HUP
        __prepare true
        clear
        __menu_config
        __clean
        exit 0
    fi

    # Handle config editing using centralized mappings
    if [[ -n "${_package}" && -n "${_config_arg}" ]]; then
        local _config_path="${_local_config_dir}/${_package}.cfg"
        local _config_url
        _config_url=$(__get_config_url "${_package}")
        local _config_name="${_package}"

        # Disable exit trap before editing config
        trap - INT TERM EXIT HUP

        # Handle config file editing directly
        __handle_config "${_config_name}" "${_config_path}" "${_config_url}"

        # Display exit messages
        __banner
        __msg_plain "${_green_mint}Closed... Finish${_break}"

        # Clean exit
        __clean
        exit 0
    fi

    # Handle regular install commands using lookup table
    declare -A _install_funcs=(
        [linux]=__linux_install [l]=__linux_install
        [nvidia]=__nvidia_install [n]=__nvidia_install
        [mesa]=__mesa_install [m]=__mesa_install
        [amdgpu]=__amdgpu_pro_install [ag]=__amdgpu_pro_install
        [amdvlk]=__amdvlk_opt_install [av]=__amdvlk_opt_install
        [wine]=__wine_install [w]=__wine_install
        [proton]=__proton_install [p]=__proton_install
        [dxvk]=__dxvk_tools_prepare [d]=__dxvk_tools_prepare
        [gamescope]=__gamescope_install [g]=__gamescope_install
        [glibc]=__glibc_install [ge]=__glibc_install
    )

    # Check if command maps to an install function
    if [[ -n "${_install_funcs[${_arg1}]:-}" ]]; then
        __prepare
        "${_install_funcs[${_arg1}]}"
        return
    fi

    # Handle special commands
    case "${_arg1}" in
        clean | --clean)
            __clean_temp_dir
            exit 0 >/dev/null 2>&1
            ;;
        help | h | --help | -h)
            # Handle help command
            ;;
        *)
            __banner "${_orange}"
            __msg_warning "Invalid argument:${_reset}${_gray} ${1:-} ${2:-}${_reset}${_break}"
            __msg_plain " The argument is either invalid or incomplete."
            __msg_plain " All available arguments run:${_break}"
            __msg_plain "$0 help${_break}"
            trap - INT TERM EXIT HUP
            __clean
            exit 1
            ;;
    esac
}

# Main function for interactive mode
__main_interactive_mode() {
    # Initialize dynamic preview content for fzf menus
    __prepare true
    clear
    __menu || {
        __banner "${_red}"
        __msg_error "Failed to initialize fzf menu!"
        __msg_plain " Exiting..."
        trap - INT TERM EXIT HUP
        __clean
        exit 1
    }

    # Process user selection from menu
    local _user_choice=""
    if [[ -f "${_tkg_choice_file}" ]]; then
        _user_choice=$(<"${_tkg_choice_file}")
    fi

    # Handle empty choice (ESC/Ctrl-C pressed)
    if [[ -z "${_user_choice:-}" ]]; then
        clear
        __exit 0
    fi

    # Remove temporary choice file
    rm -f "${_tkg_choice_file}"

    # Define install handlers
    declare -A _menu_handlers=(
        [Linux]=__linux_install [Nvidia]=__nvidia_install [Mesa]=__mesa_install
        [Wine]=__wine_install [Proton]=__proton_install
        [Gamescope]=__gamescope_install [Glibc]=__glibc_install
    )

    # Handle standard installations
    if [[ -n "${_menu_handlers[${_user_choice}]:-}" ]]; then
        __banner
        __clear_line 120
        "${_menu_handlers[${_user_choice}]}"
        return
    fi

    # Handle special menu options
    case ${_user_choice} in
        AMD)
            __banner
            __clear_line 120
            __menu_amd
            clear
            exec "$0"
            ;;
        Config)
            __menu_config
            clear
            exec "$0"
            ;;
        Help)
            trap - INT TERM EXIT HUP
            __help
            __clean
            exit 0
            ;;
        Clean)
            __clean_temp_dir
            exit 0 >/dev/null 2>&1
            ;;
        Close)
            exit 0
            ;;
    esac
}

# Main function handles command line arguments and menu interaction
__main() {
    if [[ $# -gt 0 ]]; then
        __main_direct_mode "$@"
    else
        __main_interactive_mode
    fi
}

# SCRIPT EXECUTION ENTRY POINT
__main "$@"
