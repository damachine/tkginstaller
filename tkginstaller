#!/usr/bin/env bash
set -euo pipefail

# TKG-Installer VERSION definition
_tkg_installer_version="v0.29.1"

# -----------------------------------------------------------------------------
# author : damachine (damachin3 at proton dot me)
# website: https://github.com/damachine
#          https://github.com/damachine/tkginstaller
# -----------------------------------------------------------------------------
# MIT License
#
# Copyright (c) 2025 damachine
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
# -----------------------------------------------------------------------------
# INFO:
#   TKG-Installer
#   Easily build the TKG packages from the Frogging-Family repositories.
# DESCRIPTION:
#   This script handles building, installation and configuration for TKG/Frogminer packages.
#   It uses color output and Unicode icons for better readability.
#   Do not run as root. Use a dedicated user for security.
#   See https://github.com/damachine/tkginstaller for details.
# USAGE:
#   Interactive (Menu-mode) Run the script without arguments to enter the menu:
#       run: tkginstaller
#   Command-line (Direct-mode) Skip the menu and run specific actions directly:
#       run: tkginstaller linux          # Install Linux-TKG
#       run: tkginstaller linux config   # Edit Linux-TKG config
#   Show all available commands and shortcuts!
#       run: tkginstaller help
# -----------------------------------------------------------------------------

# =============================================================================
# ENVIRONMENT SETUP
# =============================================================================

# Global variables, paths, and configurations
_tkg_tmp_dir=${HOME}/.tkginstaller/.cache
_tkg_choice_file=${_tkg_tmp_dir}/.choice.tmp
_local_config_dir=${HOME}/.config/frogminer
_tkg_repo_url=https://github.com/damachine/tkginstaller
_tkg_raw_url=https://raw.githubusercontent.com/damachine/tkginstaller/refs/heads/master/docs
_frog_repo_url=https://github.com/Frogging-Family
_frog_raw_url=https://raw.githubusercontent.com/Frogging-Family

# Curl timeout configuration
_curl_max_time=10
_curl_connect_timeout=5
_curl_opts="--max-time ${_curl_max_time} --connect-timeout ${_curl_connect_timeout} -fsSL"

# Export only variables used in fzf preview commands
export _tkg_tmp_dir _local_config_dir _tkg_raw_url _frog_raw_url _curl_opts

# Human-readable display names
declare -gA _pkg_display_name=(
    [linux]="Linux-TKG"
    [nvidia]="Nvidia-all"
    [mesa]="Mesa-TKG"
    [amdgpu]="AMDGPU-PRO"
    [amdvlk]="AMDVLK-OPT"
    [wine]="Wine-TKG"
    [proton]="Proton-TKG"
    [dxvk]="DXVK"
    [vkd3d]="vkd3d-proton"
)

# Git repository URLs (requires _frog_repo_url from __init_globals)
declare -gA _pkg_repo=(
    [linux]="${_frog_repo_url}/linux-tkg.git"
    [nvidia]="${_frog_repo_url}/nvidia-all.git"
    [mesa]="${_frog_repo_url}/mesa-git.git"
    [amdgpu]="${_frog_repo_url}/amdgpu-pro-vulkan-only.git"
    [amdvlk]="${_frog_repo_url}/amdvlk-opt.git"
    [wine]="${_frog_repo_url}/wine-tkg-git.git"
    [proton]="${_frog_repo_url}/wine-tkg-git.git"
    [dxvk]="${_frog_repo_url}/dxvk-tools.git"
)

# Configuration file paths (relative to _frog_raw_url)
declare -gA _pkg_config_path=(
    [linux]="linux-tkg/master/customization.cfg"
    [nvidia]="nvidia-all/master/customization.cfg"
    [mesa]="mesa-git/master/customization.cfg"
    [amdgpu]="amdgpu-pro-vulkan-only/master/customization.cfg"
    [amdvlk]="amdvlk-opt/master/amdvlk-buildfromsource/customization.cfg"
    [wine]="wine-tkg-git/refs/heads/master/wine-tkg-git/customization.cfg"
    [proton]="wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg.cfg"
    [dxvk]="dxvk-tools/master/updxvk.cfg"
    [vkd3d]="dxvk-tools/master/upvkd3d-proton.cfg"
)

# Optional: Subdirectory to enter after git clone
declare -gA _pkg_workdir=(
    [amdvlk]="amdvlk-buildfromsource"
    [wine]="wine-tkg-git"
    [proton]="proton-tkg"
)

# Default build commands (for packages using __install_pkg_key)
declare -gA _pkg_default_cmd=(
    [nvidia]="makepkg -si"
    [mesa]="makepkg -si"
    [amdgpu]="makepkg -si"
    [amdvlk]="makepkg -si"
)

# Local config filenames (preserves established naming for user configs)
declare -gA _pkg_local_config=(
    [linux]="linux-tkg.cfg"
    [nvidia]="nvidia-all.cfg"
    [mesa]="mesa-git.cfg"
    [amdgpu]="amdgpu-pro.cfg"
    [amdvlk]="amdvlk-opt.cfg"
    [wine]="wine-tkg.cfg"
    [proton]="proton-tkg.cfg"
    [dxvk]="updxvk.cfg"
    [vkd3d]="upvkd3d-proton.cfg"
)

# Normalize package argument to internal key
__normalize_package() {
    case "${1,,}" in
        linux | l | --linux | -l) echo "linux" ;;
        nvidia | n | --nvidia | -n) echo "nvidia" ;;
        mesa | m | --mesa | -m) echo "mesa" ;;
        amdgpu | ag | --amdgpu | -ag) echo "amdgpu" ;;
        amdvlk | av | --amdvlk | -av) echo "amdvlk" ;;
        wine | w | --wine | -w) echo "wine" ;;
        proton | p | --proton | -p) echo "proton" ;;
        *) echo "" ;;
    esac
}

# Check if argument is a config command
__is_config_arg() {
    [[ "${1,,}" =~ ^(config|c|edit|e|customize|cu)$ ]]
}

# Get full config URL for a package
__get_config_url() {
    local _pkg="$1"
    [[ -n "${_pkg_config_path[$_pkg]:-}" ]] && echo "${_frog_raw_url}/${_pkg_config_path[$_pkg]}"
}

# Initialize color and formatting
__init_style() {
    __clear_line() { printf '\r%*s\r\033[A' "$@"; }
    _break=$'\n'
    _reset=$'\033[0m'

    # Helper to return TrueColor escape if supported
    __color() {
        # $1 = r, $2 = g, $3 = b, $4 = fallback tput color index (0-7)
        local r=${1:-255} g=${2:-255} b=${3:-255} idx=${4:-7}

        # Detect basic TrueColor support
        if [[ "${COLORTERM,,}" == *truecolor* || "${COLORTERM,,}" == *24bit* ]]; then
            printf '\033[38;2;%d;%d;%dm' "$r" "$g" "$b"
            return 0
        fi

        # Fallback to tput
        if command -v tput >/dev/null 2>&1; then
            local _tput_seq
            _tput_seq=$(
                tput sgr0
                tput setaf "$idx"
            ) # Reset attributes, then set foreground color
            printf '%s' "${_tput_seq}"
            return 0
        fi

        # Fallback to 256-color approx idx: 1=red, 2=green, 3=yellow, 4=blue
        local _idx256
        case "$idx" in
            1) _idx256=196 ;; # bright red
            2) _idx256=118 ;; # light/bright green
            3) _idx256=214 ;; # orange/yellow
            4) _idx256=39 ;;  # bright blue/cyan-ish
            *) _idx256=15 ;;  # white
        esac
        printf '\033[38;5;%dm' "$_idx256"
    }

    # Define TrueColor values, fallback to tput
    _red="$(__color 220 60 60 1)"          # warm red
    _green_light="$(__color 80 255 140 2)" # light green
    _green_neon="$(__color 120 255 100 2)" # neon green
    _green_mint="$(__color 152 255 200 6)" # mint green
    _green_dark="$(__color 34 68 34 2)"    # dark green (#224422)
    _orange="$(__color 255 190 60 3)"      # orange/yellow
    _gray="$(__color 200 250 200 7)"       # gray

    # Draw underline
    _uline_on=$(tput smul 2>/dev/null || printf '\033[4m')
    _uline_off=$(tput rmul 2>/dev/null || printf '\033[24m')

    # Calculate terminal width
    _cols="$(tput cols 2>/dev/null || echo 80)"
    local _line_len=$((_cols / 2))
    if [[ "$_line_len" -lt 80 ]]; then
        _line_len=80
    fi
    _line=""
    for ((i = 0; i < "$_line_len"; i++)); do _line+="â”€"; done

    # Export only variables must be used in fzf preview commands to work properly
    export _break _reset _green_light _green_neon _green_mint _green_dark _orange _gray _uline_on _uline_off _cols _line
}

# Display banner
__banner() {
    local __color="${1:-$_green_neon}"
    printf "%b\n" "${__color}"
    cat <<EOF
â–‘â–€â–ˆâ–€â–‘â–ˆâ–‘â–ˆâ–‘â–ˆâ–€â–€â–‘â–‘â–‘â–‘â–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–ˆâ–‘â–ˆâ–€â–€â–‘â–€â–ˆâ–€â–‘â–ˆâ–€â–ˆâ–‘â–ˆâ–‘â–‘â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–„
â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–€â–„â–‘â–ˆâ–‘â–ˆâ–‘â–„â–„â–„â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–ˆâ–‘â–€â–€â–ˆâ–‘â–‘â–ˆâ–‘â–‘â–ˆâ–€â–ˆâ–‘â–ˆâ–‘â–‘â–‘â–ˆâ–‘â–‘â–‘â–ˆâ–€â–€â–‘â–ˆâ–€â–„
â–‘â–‘â–€â–‘â–‘â–€â–‘â–€â–‘â–€â–€â–€â–‘â–‘â–‘â–‘â–‘â–€â–€â–€â–‘â–€â–‘â–€â–‘â–€â–€â–€â–‘â–‘â–€â–‘â–‘â–€â–‘â–€â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–€â–€â–‘â–€â–‘â–€
â”€â”€  ${_tkg_installer_version}  â”€â”€
EOF
    printf "%b\n" "$_reset"
}

# =============================================================================
# INITIALIZATION AND PRE-CHECKS
# =============================================================================

# Initialize style and colors
__init_style

# Unified message function
__msg() {
    local _msg_first="${1:-}" _msg_level _msg
    if [[ "${_msg_first,,}" =~ ^(info_(green|orange|neon|mint|blue)|warning|error|prompt|plain)$ ]]; then
        _msg_level="${_msg_first,,}"
        shift
        _msg="$*"
    else
        _msg_level="plain"
        _msg="$*"
    fi

    # Ensure colors exist
    : "${_reset:=''}" "${_red:=''}" "${_green_light:=''}" "${_green_neon:=''}" "${_green_mint:=''}" "${_green_dark:=''}" "${_orange:=''}" "${_gray:=''}" "${_uline_on:=''}" "${_uline_off:=''}"

    # Map level
    local __color="" _prefix=""

    case "${_msg_level}" in
        prompt)
            printf '%b' "$_msg"
            return 0
            ;;
        info_green)
            __color="${_green_light}"
            _prefix=""
            ;;
        info_neon)
            __color="${_green_neon}"
            _prefix=""
            ;;
        info_mint)
            __color="${_green_mint}"
            _prefix=""
            ;;
        info_orange)
            __color="${_orange}"
            _prefix=""
            ;;
        warning)
            __color="${_orange}"
            _prefix="${_uline_on}WARNING${_uline_off}:${__color} "
            ;;
        error)
            __color="${_red}"
            _prefix="${_uline_on}ERROR${_uline_off}:${__color} "
            ;;
        *)
            __color="${_reset}"
            _prefix=""
            ;;
    esac

    # Print formatted line with color and reset
    printf '%b\n' "${__color}${_prefix}${_msg}${_reset}"
}

# Message functions
__msg_info() { __msg 'info_green' "$@"; }
__msg_info_neon() { __msg 'info_neon' "$@"; }
__msg_info_mint() { __msg 'info_mint' "$@"; }
__msg_info_orange() { __msg 'info_orange' "$@"; }
__msg_warning() { __msg 'warning' "$@"; }
__msg_error() { __msg 'error' "$@"; }
__msg_prompt() { __msg 'prompt' "$@"; }
__msg_plain() { __msg 'plain' "$@"; }

# Display package information
__msg_pkg() {
    local _pkg_name="${1:-TKG package}"
    local _config_url="${2:-${_frog_repo_url}}"

    __msg_info "${_break}${_green_neon}${_uline_on}INFO${_uline_off}:${_reset} ${_green_light}Configuration Options for ${_pkg_name}${_reset}${_break}"
    __msg_plain " A wide range of options are available!"
    __msg_plain " TKG packages can be precisely tailored to your system.${_reset}${_break}"
    __msg_plain " Set up ${_gray}customization.cfg${_reset} using one of the following options:${_reset}${_break}"
    __msg_plain " ${_orange}A${_reset} â”‚ tkginstaller -> Config -> ${_pkg_name,,}${_reset}  ${_gray}(interactive)${_reset}"
    __msg_plain " ${_orange}B${_reset} â”‚ tkginstaller ${_pkg_name,,} config        ${_gray}(direct)${_reset}${_break}"
    __msg_plain " You will find detailed instructions at:${_reset}"
    __msg_plain " ${_gray}${_config_url}${_reset}"
}

# Check for root
if [[ "$(id -u)" -eq 0 ]]; then
    __banner "$_orange"
    __msg_warning "You are running as root!${_break}"
    __msg_plain " Running this script as root is not recommended for security reasons.${_break}"
    __msg_prompt "Do you really want to continue as root? [y/N]: "
    trap 'echo;echo; __msg_plain "${_red}Aborted by user.\n";sleep 1.5s; exit 1' INT
    read -r _user_answer
    trap - INT
    if [[ "$_user_answer" =~ ^([yY]|[yY][eE][sS])$ ]]; then
        # User confirmed - continue
        :
    elif [[ "$_user_answer" =~ ^([nN]|[nN][oO])$ ]]; then
        # Explicit no
        __msg_plain "${_break}${_red}Aborted by user.${_break}"
        exit 1
    else
        # Invalid input - treat as no (default)
        __msg_plain "${_break}${_orange}Invalid input. Defaulting to 'No'.${_break}"
        __msg_plain "${_red}Aborted.${_break}"
        exit 1
    fi
fi

# Detect Linux Distribution
if [[ -f /etc/os-release ]]; then
    # shellcheck disable=SC1091 # Source file is system-dependent and may not exist on all systems
    . /etc/os-release
    _distro_name="$NAME"
    _distro_id="${ID:-unknown}"
    _distro_like="${ID_LIKE:-}"
else
    _distro_name="Unknown"
    _distro_id="unknown"
    _distro_like=""
fi

# Check if distribution is Arch-based
if [[ "${_distro_id,,}" =~ ^(arch|cachyos|manjaro|endeavouros)$ || "${_distro_like,,}" == *"arch"* ]]; then
    _is_arch_based="true"
else
    _is_arch_based="false"
fi

# Help information display
__help() {
    __banner
    cat <<EOF
${_green_neon}${_uline_on}HELP${_uline_off}:${_reset} ${_green_light}TKG-Installer usage and commands${_reset}

${_green_neon}1) Interactive mode${_reset}
   Run without arguments to enter the menu:
   ${_gray}tkginstaller${_reset}

${_green_neon}2) Direct mode${_reset}
   Run specific packages directly:
   ${_gray}tkginstaller [linux|l|nvidia|n|mesa|m|wine|w|proton|p]${_reset}

${_green_neon}3) Config editing${_reset}
   Edit configuration files:
   ${_gray}tkginstaller [linux|l|nvidia|n|mesa|m|wine|w|proton|p] [config|c|edit|e]${_reset}

${_orange}Shortcuts:${_reset} ${_gray}l${_reset}=linux, ${_gray}n${_reset}=nvidia, ${_gray}m${_reset}=mesa, ${_gray}w${_reset}=wine, ${_gray}p${_reset}=proton, ${_gray}c${_reset}=config, ${_gray}e${_reset}=edit

EOF
}

# Help can show always!
[[ $# -gt 0 && "${1:-}" =~ ^(help|h|--help|-h)$ ]] && {
    __help
    exit 0
}

# =============================================================================
# CORE UTILITY FUNCTIONS
# =============================================================================

# Pre-installation checks
__prepare() {
    _load_preview="${1:-false}"

    # Welcome message
    __banner
    printf "%s" "${_green_neon}Starting"
    for _ in {1..3}; do
        printf " ."
        sleep 0.3s
    done
    printf "%b\n" "${_reset}"

    # Check required dependencies
    local _dep=(git onefetch)
    if [[ "$_load_preview" == "true" ]]; then
        # Add optional dependencies
        _dep+=(bat curl glow fzf wdiff)
    fi

    # Define package names per distro
    declare -A _pkg_map_dep=(
        [git]=git
        [bat]=bat
        [curl]=curl
        [glow]=glow
        [fzf]=fzf
        [onefetch]=onefetch
        [wdiff]=wdiff
    )

    # Set install command based on distro
    case "${_distro_id,,}" in
        arch | manjaro | endeavouros | cachyos)
            _install_cmd_dep="pacman -S"
            ;;
        fedora)
            _install_cmd_dep="dnf install"
            ;;
        opensuse* | suse*)
            _install_cmd_dep="zypper install"
            ;;
        gentoo)
            # Gentoo uses category/package format
            declare -A _gentoo_categories=(
                [git]=dev-vcs
                [bat]=app-misc
                [curl]=net-misc
                [glow]=app-text
                [fzf]=app-misc
                [onefetch]=app-misc
                [wdiff]=app-text
            )
            for pkg in "${!_pkg_map_dep[@]}"; do
                _pkg_map_dep[$pkg]="${_gentoo_categories[$pkg]}/${pkg}"
            done
            _install_cmd_dep="emerge"
            ;;
        debian | ubuntu | linuxmint | pop | elementary | mx | raspbian)
            _install_cmd_dep="apt install"
            ;;
        *)
            _install_cmd_dep="your-package-manager install"
            ;;
    esac

    # Check for missing dependencies
    local _missing_dep=()
    for _required_dep in "${_dep[@]}"; do
        if ! command -v "$_required_dep" >/dev/null 2>&1; then
            _missing_dep+=("$_required_dep")
        fi
    done

    if [[ ${#_missing_dep[@]} -gt 0 ]]; then
        for i in {1..7}; do
            __clear_line 120 ""
        done
        __banner "$_red"
        __msg_error "Missing dependencies detected.${_break}"
        __msg_plain " Please install the following dependencies first:${_break}"

        local _pkg_name_dep=()
        for _dependency in "${_missing_dep[@]}"; do
            _pkg_name_dep+=("${_pkg_map_dep[$_dependency]:-$_dependency}")
        done

        # Display installation command
        __msg_plain "${_install_cmd_dep} ${_pkg_name_dep[*]}${_break}"

        # Exit with error code
        exit 1 >/dev/null 2>&1
    fi

    # Setup temporary directory
    rm -f "$_tkg_choice_file" 2>/dev/null || true
    # Cache is preserved to allow git pull updates instead of fresh clones
    mkdir -p "$_tkg_tmp_dir" 2>/dev/null || {
        for i in {1..7}; do
            __clear_line 120 ""
        done
        __banner "$_red"
        __msg_error "Creating temporary directory failed: ${_tkg_tmp_dir}${_break}"
        __msg_plain " Please check your permissions and try again.${_break}"
        exit 1 >/dev/null 2>&1
    }

    # Entering TKG-Installer
    if [[ "$_load_preview" == "true" ]]; then
        __msg_plain "${_green_neon}Entering interactive menu${_reset}"
    else
        __msg_plain "${_green_neon}Running direct installation${_reset}"
    fi

    # Short delay for better UX
    sleep 0.5s
}

# Display completion status
__status() {
    local _status=${1:-$?}
    local _package_name="${2:-}"
    local _duration="${SECONDS:-0}"
    local _minutes=$((_duration / 60))
    local _seconds=$((_duration % 60))

    # Finisher message display
    __msg_info_orange "${_break}Action completed: $(date '+%Y-%m-%d %H:%M:%S')"
    if [[ $_status -eq 0 ]]; then
        if [[ -n "$_package_name" ]]; then
            __msg_info "Status: ${_package_name} successfully completed!"
        else
            __msg_info "Status: Successfully completed!"
        fi
    else
        if [[ -n "$_package_name" ]]; then
            __msg_error "Failed process: ${_package_name} (Code: $_status)"
        else
            __msg_error "Failed process (Code: $_status)"
        fi
    fi
    __msg_info_orange "Duration: ${_minutes} min ${_seconds} sec"
}

# Setup exit trap for cleanup on script termination and errors
__exit() {
    local _exit_code=${1:-$?}
    trap - INT TERM EXIT HUP

    # Message handling on exit with banner and status first
    if [[ $_exit_code -ne 0 ]]; then
        __banner "$_red"

        # Show completion info for interrupted processes
        local _duration="${SECONDS:-0}"
        local _minutes=$((_duration / 60))
        local _seconds=$((_duration % 60))
        __msg_info_orange "${_break}Action completed: $(date '+%Y-%m-%d %H:%M:%S')"
        __msg_error "Failed process (Code: $_exit_code)"
        __msg_info_orange "Duration: ${_minutes} min ${_seconds} sec${_break}"

        __msg_plain "${_red} Exiting due to errors. Please check the messages above for details.${_break}"
    else
        __banner
        __msg_plain "${_green_neon}Closed... Finish${_break}"
    fi

    # Perform cleanup
    __clean || true
    wait
    exit "$_exit_code"
}

# Ensure signals lead to __exit with non-zero code so __exit shows error output.
trap 'trap - INT TERM EXIT HUP; __exit 130' INT TERM HUP
trap '__exit $?' EXIT

# Cleanup handler
__clean() {
    # Remove temporary files but preserve cache directory for git pull updates
    rm -f "$_tkg_choice_file" 2>/dev/null || true

    # Unset all variables
    unset _tkg_tmp_dir _local_config_dir _tkg_raw_url _frog_raw_url _curl_opts
    unset _break _reset _green_light _green_neon _green_mint _green_dark _orange _gray _uline_on _uline_off _cols _line
}

# Clean temporary files and cache
__clean_temp_dir() {
    __banner
    __msg_info "Cleaning all temporary files...${_break}"
    __msg_plain " Location:${_reset}${_gray} ${_tkg_tmp_dir}${_reset}${_break}"
    local _cache_count=0
    local _cache_size_bytes=0
    local _cache_size_human=""

    if [[ -d "${_tkg_tmp_dir}" ]]; then
        _cache_count=$(find "${_tkg_tmp_dir}" -type f 2>/dev/null | wc -l || echo 0)
        _cache_size_bytes=$(du -sb "${_tkg_tmp_dir}" 2>/dev/null | cut -f1 || echo 0)
        _cache_size_human=$(du -sh "${_tkg_tmp_dir}" 2>/dev/null | cut -f1 || echo "0B")
    fi

    rm -f "$_tkg_choice_file" 2>&1 || true
    rm -rf "$_tkg_tmp_dir" 2>&1 || true
    sleep 1.5s

    if [[ "$_cache_count" -eq 0 ]]; then
        __msg_plain "${_green_neon}Cleanup complete ${_gray}(nothing to remove, cache already clean)${_reset}${_break}"
    else
        __msg_plain "${_green_neon}Cleanup complete ${_gray}(${_cache_count} cached files removed, ${_cache_size_human} freed)${_reset}${_break}"
    fi
}

# Fuzzy finder menu wrapper function
__fzf_menu() {
    # $1: MenÃ¼-Inhalt, $2: Preview-Command, $3: Header, $4: Footer, $5: Label (optional), $6: Preview-Window-Settings (optional)
    local _menu_content="$1"
    local _preview_command="$2"
    local _header_text="$3"
    local _footer_text="$4"
    local _border_label_text="${5:-$_tkg_installer_version}"
    local _preview_window_settings="${6:-right:wrap:55%}"
    local _fzf_bind="${7:-ctrl-p:toggle-preview}"

    # Run fzf with consistent styling and options
    fzf \
        --with-shell='bash -c' \
        --style default \
        --color='current-fg:#78FF64,current-bg:#224422,gutter:#224422,pointer:#224422,border:#224422,scrollbar:#224422:bold' \
        --border=sharp \
        --layout=reverse \
        --highlight-line \
        --height='-1' \
        --ansi \
        --delimiter='|' \
        --with-nth='2' \
        --gap='0' \
        --no-extended \
        --no-input \
        --no-multi \
        --no-multi-line \
        --cycle \
        --header="${_header_text}" \
        --header-border=line \
        --header-label="${_green_dark}${_border_label_text}" \
        --header-label-pos=2048 \
        --header-first \
        --footer="${_footer_text}" \
        --footer-border=line \
        --preview-window="${_preview_window_settings}" \
        --preview="${_preview_command}" \
        --preview-border=line \
        --bind='esc:abort,ctrl-c:abort' \
        --bind="${_fzf_bind}" \
        --disabled \
        <<<"${_menu_content}" || true
}

# =============================================================================
# INSTALLATION FUNCTIONS
# =============================================================================

# Generic package installation helper function
__install_package() {
    SECONDS=0
    local _repo_url="$1"
    local _package_name="$2"
    local _build_command="$3"
    local _work_directory="${4:-}"

    # Enter temporary directory
    cd "${_tkg_tmp_dir}" >/dev/null 2>&1 || {
        __msg_error "Failed to enter temporary directory: ${_tkg_tmp_dir}${_break}"
        return 1
    }

    # Clone or update repository (git pull if exists, clone if not)
    local _repo_dir
    _repo_dir=$(basename "${_repo_url}" .git)

    if [[ -d "${_repo_dir}/.git" ]]; then
        # Repository exists - update with git pull (recommended by linux-tkg)
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Updating ${_gray}$_package_name${_reset} ${_green_light}(git pull)...${_reset}${_break}"
        cd "${_repo_dir}" >/dev/null 2>&1 || {
            __msg_error "Cannot enter repository directory: ${_repo_dir}${_break}"
            return 1
        }
        git pull >/dev/null 2>&1 || {
            __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Git pull failed, trying fresh clone...${_reset}${_break}"
            cd "${_tkg_tmp_dir}" >/dev/null 2>&1 || return 1
            rm -rf "${_repo_dir}" 2>/dev/null || true
            git clone "$_repo_url" >/dev/null 2>&1 || {
                __msg_error "Cloning failed for: $_package_name${_break}"
                __msg_plain " Please check your internet connection and try again."
                return 1
            }
        }
        cd "${_tkg_tmp_dir}" >/dev/null 2>&1 || return 1
    else
        # Fresh clone
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Cloning ${_gray}$_package_name${_reset} ${_green_light}from Frogging-Family repository...${_reset}${_break}"
        git clone "$_repo_url" >/dev/null 2>&1 || {
            __msg_error "Cloning failed for: $_package_name${_break}"
            __msg_plain " Please check your internet connection and try again."
            return 1
        }
    fi

    # Enter repository directory
    cd "${_repo_dir}" >/dev/null 2>&1 || {
        __msg_error "Cloned repository directory not found: ${_repo_dir}${_break}"
        __msg_plain " Please check your path or permissions and try again."
        return 1
    }

    # Navigate to working directory (wine/proton)
    if [[ -n "${_work_directory}" ]]; then
        cd "${_work_directory}" >/dev/null 2>&1 || {
            __msg_error "Working directory not found: ${_work_directory}${_break}"
            __msg_plain " Please check your path or permissions and try again."
            return 1
        }
    fi

    # Display onefetch
    onefetch --no-bold --no-title --no-art --no-color-palette --http-url --email --nerd-fonts --text-colors 15 15 15 15 15 8 2>/dev/null | sed -u 's/^/ /' || true
    sleep 1.5s # Short delay

    # Build and install the package
    __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building and installing ${_gray}$_package_name${_reset} ${_green_light}for ${_gray}$_distro_name, ${_reset}${_orange}this may take a while...${_reset}${_break}"
    eval "$_build_command"
    local _status=$?

    # Display completion status
    __status "$_status" "$_package_name"
    return "$_status"
}

# Generic package installation via registry
__install_pkg_key() {
    local _key="$1"
    local _repo="${_pkg_repo[$_key]}"
    local _name="${_pkg_display_name[$_key]}"
    local _cmd="${_pkg_default_cmd[$_key]}"
    local _workdir="${_pkg_workdir[$_key]:-}"
    local _config_url="${_pkg_config_path[$_key]:-}"

    # Inform user about external configuration if available
    if [[ -n "$_config_url" ]]; then
        __msg_pkg "$_name" "$_config_url"
    fi

    # Execute installation process
    __install_package "$_repo" "$_key" "$_cmd" "$_workdir"
}

# Countdown prompt with timeout
__prompt_timer() {
    local _prompt_options="${1:-[1/2]}"
    local _timeout="${2:-60}"
    local _default="${3:-1}"
    local _old_trap_int=""

    _old_trap_int=$(trap -p INT 2>/dev/null) || true

    _seconds_left="$_timeout"
    _user_answer=""
    local _abort_flag=false

    # Set trap to abort cleanly
    trap '__clear_line 120 ""; echo; echo; __msg_plain "${_red}Aborted by user!${_break}"; _abort_flag=true; break' INT

    # Simple progress display without complex bar
    while [[ $_seconds_left -gt 0 && $_abort_flag == false ]]; do
        # Calculate simple progress percentage
        local _progress_pct=$((((_timeout - _seconds_left) * 100) / _timeout))

        # Display simple prompt with dots
        local _dots=""
        case $((_seconds_left % 4)) in
            3) _dots="   " ;;
            2) _dots=".  " ;;
            1) _dots=".. " ;;
            0) _dots="..." ;;
        esac

        # Display styled prompt
        printf "\r${_gray}%s${_reset} ${_green_dark}%d%%${_reset} ${_orange}%02d${_gray}s${_reset} %s" \
            "$_prompt_options" "$_progress_pct" "$_seconds_left" "$_dots"

        if read -r -t 1 _user_answer; then
            __clear_line 120 ""
            break
        fi
        ((_seconds_left--))
    done

    # Handle abort
    if [[ $_abort_flag == true ]]; then
        sleep 1.5s
        exit 130
    fi
    __clear_line 120 ""

    # Default if no answer
    : "${_user_answer:=$_default}"

    # Restore previous INT trap
    if [[ -n "$_old_trap_int" ]]; then
        eval "$_old_trap_int"
    else
        trap - INT
    fi
}

# Prompt user with default value
__prompt_answer() {
    local _default="${1:-n}"
    read -r _user_answer
    : "${_user_answer:=$_default}"
}

# Linux-TKG installation
__linux_install() {
    # Inform user about external configuration
    __msg_pkg "Linux-TKG" "${_frog_repo_url}/linux-tkg/blob/master/customization.cfg"

    # Determine build command
    local _build_command
    local _pkg_type=""

    if [[ "${_is_arch_based}" == "true" ]]; then
        # Arch-based distributions build system to use
        __msg_info "${_break}${_green_neon}${_uline_on}CHOICE${_uline_off}:${_reset} ${_green_light}Which installations method do you want to perform${_reset}${_break}"
        __msg_plain " Detected distro: ${_gray}${_distro_name}${_reset}${_break}"
        __msg_plain " ${_green_neon}${_uline_on}1${_uline_off}${_reset} â”‚ makepkg -si           ${_green_light}recommended for Arch${_reset}"
        __msg_plain " ${_orange}2${_reset} â”‚ install.sh install    ${_gray}(generic script)${_reset}"
        __msg_plain " ${_gray}9${_reset} â”‚ install.sh uninstall  ${_gray}(show uninstall help)${_reset}"
        __msg_plain " ${_red}0${_reset} â”‚ Cancel${_break}"

        __prompt_timer "[${_green_neon}${_uline_on}1${_uline_off}${_reset}/${_orange}2${_reset}/${_gray}9${_reset}/${_red}0${_reset}]" 60 1

        case "$_user_answer" in
            0)
                __msg_info "${_break}${_break}${_orange}Cancelled by user${_reset}${_break}"
                __exit 1
                ;;
            2)
                _build_command="chmod +x install.sh && ./install.sh install"
                ;;
            9)
                _build_command="chmod +x install.sh && ./install.sh uninstall-help"
                ;;
            *)
                _build_command="makepkg -si"
                ;;
        esac
    else
        # Detect DEB or RPM based distributions
        case "${_distro_id,,}" in
            debian | ubuntu | linuxmint | pop | elementary | mx | raspbian)
                _pkg_type="DEB"
                ;;
            fedora | rhel | centos | rocky | alma | opensuse* | suse*)
                _pkg_type="RPM"
                ;;
        esac

        # Show info for DEB/RPM based distros
        if [[ -n "$_pkg_type" ]]; then
            __msg_info "${_break}${_green_neon}${_uline_on}INFO${_uline_off}:${_reset}${_green_light} ${_pkg_type}-based distribution detected: ${_gray}${_distro_name}${_reset}${_break}"
            __msg_plain " The install.sh script will create ${_gray}.${_pkg_type,,}${_reset} packages,"
            __msg_plain " move them to the ${_gray}${_pkg_type}S${_reset} subfolder, then prompt to install.${_break}"
        else
            __msg_info "${_break}${_green_neon}${_uline_on}INFO${_uline_off}:${_reset}${_green_light} Linux distribution detected: ${_gray}${_distro_name}${_reset}${_break}"
        fi

        # Non-Arch distributions use install.sh
        _build_command="chmod +x install.sh && ./install.sh install"
    fi

    # Execute installation process
    __install_package "${_pkg_repo[linux]}" "linux-tkg" "$_build_command"
    local _status=$?

    # Offer uninstall info for non-Arch distros after successful installation
    if [[ "${_is_arch_based}" != "true" && $_status -eq 0 ]]; then
        __msg_info "${_break}${_green_neon}${_uline_on}TIP${_uline_off}:${_reset}${_green_light} Uninstalling custom kernels has to be done manually.${_break}"
        __msg_plain " The install.sh script can help with useful information:${_break}"
        __msg_plain " ${_gray}cd ${_tkg_tmp_dir}/linux-tkg && ./install.sh uninstall-help${_reset}${_break}"
        __msg_prompt "${_break}Show uninstall info now? [y/N]: "
        read -r _show_info
        if [[ "${_show_info,,}" =~ ^(y|yes)$ ]]; then
            __msg_info "${_break}${_green_neon}${_uline_on}UNINSTALL-HELP${_uline_off}:${_reset}${_break}"
            cd "${_tkg_tmp_dir}/linux-tkg" >/dev/null 2>&1 && ./install.sh uninstall-help 2>/dev/null || true
        fi
    fi

    return "${_status:-0}"
}

# Nvidia-all installation
__nvidia_install() {
    __install_pkg_key "nvidia"
}

# Mesa-TKG installation
__mesa_install() {
    __install_pkg_key "mesa"
}

# AMDGPU-PRO installation
__amdgpu_pro_install() {
    __install_pkg_key "amdgpu"
}

# AMDVLK-OPT installation
__amdvlk_opt_install() {
    __install_pkg_key "amdvlk"
}

# Wine-TKG installation
__wine_install() {
    # Inform user about external configuration usage
    __msg_pkg "Wine-TKG" "${_frog_repo_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/customization.cfg"

    # Determine build command
    local _build_command

    if [[ "${_is_arch_based}" == "true" ]]; then
        # Arch-based distributions build system to use
        __msg_info "${_break}${_green_neon}${_uline_on}CHOICE${_uline_off}:${_reset} ${_green_light}Which build system do you want to use${_reset}${_break}"
        __msg_plain " Detected distro: ${_gray}${_distro_name}${_reset}${_break}"
        __msg_plain " ${_green_neon}${_uline_on}1${_uline_off}${_reset} â”‚ makepkg -si           ${_green_light}recommended for Arch${_reset}"
        __msg_plain " ${_orange}2${_reset} â”‚ non-makepkg-build.sh  ${_gray}(custom build script)${_reset}"
        __msg_plain " ${_red}0${_reset} â”‚ Cancel${_break}"

        # Get user choice with timeout
        __prompt_timer "[${_green_neon}${_uline_on}1${_uline_off}${_reset}/${_orange}2${_reset}/${_red}0${_reset}]" 60 1

        case "$_user_answer" in
            0)
                __msg_info "${_break}${_break}${_orange}Cancelled by user${_reset}${_break}"
                __exit 1
                ;;
            2)
                _build_command="chmod +x non-makepkg-build.sh && ./non-makepkg-build.sh"
                ;;
            *)
                _build_command="makepkg -si"
                ;;
        esac
    else
        # Non-Arch distributions
        _build_command="chmod +x non-makepkg-build.sh && ./non-makepkg-build.sh"
    fi

    # Execute installation
    __install_package "${_pkg_repo[wine]}" "wine-tkg-git" "$_build_command" "${_pkg_workdir[wine]}"
}

# DXVK-Tools preparation (optional pre-build for Proton-TKG)
__dxvk_tools_prepare() {
    # Present build options menu FIRST (before cloning)
    __msg_info "${_break}${_green_neon}${_uline_on}CHOICE${_uline_off}:${_reset} ${_green_light}Which DXVK/vkd3d build option do you want?${_reset}${_break}"
    __msg_plain " ${_orange}${_uline_on}0${_uline_off}${_reset} â”‚ No (skip)              ${_gray}Skip all builds, continue with Proton-TKG${_reset}"
    __msg_plain " ${_green_neon}1${_reset} â”‚ Yes (build both)       ${_green_light}Build DXVK + vkd3d-proton${_reset}"
    __msg_plain " ${_orange}2${_reset} â”‚ Custom                 ${_gray}Choose individually which to build${_reset}"
    __msg_plain " ${_red}9${_reset} â”‚ Cancel${_break}"

    __msg_info "${_green_neon}${_uline_on}NOTE${_uline_off}:${_reset} ${_green_light}By default, Proton-TKG downloads latest official DXVK release from GitHub.${_reset}${_break}"
    __msg_plain " You have nothing to do, it's all good. However, if you want to build/use a"
    __msg_plain " development or modified version of DXVK, it's recommended to use dxvk-tools.${_break}"

    __msg_info "${_orange}${_uline_on}IMPORTANT${_uline_off}:${_reset} ${_orange}To use the prebuilt DXVK/vkd3d tools in Proton-TKG:${_reset}${_break}"
    __msg_plain " Set ${_gray}_use_dxvk=\"prebuilt\"${_reset} in your ${_gray}proton-tkg.cfg${_reset} configuration file."
    __msg_plain " Location: ${_gray}~/.config/frogminer/proton-tkg.cfg${_reset}${_break}"
    __msg_plain " More info: ${_gray}https://github.com/Frogging-Family/wine-tkg-git/tree/master/proton-tkg#the-prebuilt-dxvk-problem${_reset}${_break}"

    __prompt_timer "[${_orange}${_uline_on}0${_uline_off}${_reset}/${_green_neon}1${_reset}/${_orange}2${_reset}/${_red}9${_reset}]" 60 0

    local _build_dxvk=false
    local _build_vkd3d=false
    local _built_something=false

    case "$_user_answer" in
        9)
            __msg_info "${_break}${_break}${_orange}Cancelled by user${_reset}${_break}"
            __exit 1
            ;;
        0)
            __msg_info "${_break}${_orange}Skipping DXVK/vkd3d builds, continue with Proton-TKG${_reset}"
            return 0
            ;;
        2)
            # Custom selection - ask individually
            __msg_prompt "${_break}Build ${_reset}${_gray}'DXVK'${_reset} (DirectX to Vulkan)? [y/N]: "
            __prompt_answer "n"
            [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && _build_dxvk=true

            __msg_prompt "Build ${_reset}${_gray}'vkd3d-proton'${_reset} (Direct3D 12 to Vulkan)? [y/N]: "
            __prompt_answer "n"
            [[ "${_user_answer,,}" =~ ^(y|yes)$ ]] && _build_vkd3d=true
            ;;
        *)
            # Build both (Option 1)
            _build_dxvk=true
            _build_vkd3d=true
            ;;
    esac

    # Clone dxvk-tools ONLY if user wants to build something (Option 1 or 3)
    if [[ "$_build_dxvk" == "true" ]] || [[ "$_build_vkd3d" == "true" ]]; then
        __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Preparing dxvk-tools${_reset}${_break}"
        __msg_plain " DXVK-tools allows building custom DXVK and vkd3d-proton versions"

        local _dxvk_dir="${_tkg_tmp_dir}/dxvk-tools"
        if [[ -d "$_dxvk_dir" ]]; then
            __msg_info " ${_green_light}dxvk-tools directory already exists, using existing clone${_reset}${_break}"
        else
            __msg_info " ${_green_light}Cloning dxvk-tools repository to '${_dxvk_dir}'...${_reset}${_break}"
            if ! git clone "${_pkg_repo[dxvk]}" "$_dxvk_dir" >/dev/null 2>&1; then
                __msg_error "Failed to clone dxvk-tools repository${_break}"
                return 1
            fi
        fi

        # Change to dxvk-tools directory and build
        cd "$_dxvk_dir" || {
            __msg_error "Failed to enter dxvk-tools directory${_break}"
            return 1
        }
    else
        # User selected 'No' or nothing to build
        return 0
    fi

    # Short delay for better UX
    sleep 1.5s

    # Build DXVK if selected
    if [[ "$_build_dxvk" == "true" ]]; then
        __msg_info "${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building DXVK...${_reset}${_break}"
        if ./updxvk build; then
            __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}DXVK build completed successfully${_reset}${_break}"
            _built_something=true
        else
            __msg_error "DXVK build failed${_break}"
            __msg_plain " Continuing anyway...${_break}"
        fi
    fi

    # Build vkd3d-proton if selected
    if [[ "$_build_vkd3d" == "true" ]]; then
        __msg_info "${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}Building vkd3d-proton...${_reset}${_break}"
        if ./upvkd3d-proton build; then
            __msg_info "${_break}${_green_neon}${_uline_on}PROGRESS${_uline_off}:${_reset} ${_green_light}vkd3d-proton build completed successfully${_reset}${_break}"
            _built_something=true
        else
            __msg_error "vkd3d-proton build failed${_reset}${_break}"
            __msg_plain " Continuing anyway...${_break}"
        fi
    fi

    # Only ask about export if something was built
    if [[ "$_built_something" == "true" ]]; then
        __msg_prompt "${_break}Do you want to ${_reset}${_gray}'export for Proton-TKG'${_reset}? [y/N]: "
        __prompt_answer "n"

        if [[ "${_user_answer,,}" =~ ^(y|yes)$ ]]; then
            __msg_info "${_break}${_green_neon}â–¶${_reset} ${_green_light}Exporting DXVK DLLs for Proton-TKG...${_reset}${_break}"
            if ./updxvk proton-tkg; then
                __msg_info "${_break}${_green_neon}â–¶${_reset} ${_green_light}Export completed successfully${_reset}${_break}"
                __msg_info "${_break}${_green_neon}${_uline_on}TIP${_uline_off}:${_reset} ${_green_light}DXVK DLLs are ready for Proton-TKG build${_reset}${_break}"
            else
                __msg_error "Export failed${_break}"
                __msg_plain " Continuing with Proton-TKG build anyway...${_break}"
            fi
        fi
    else
        __msg_info "${_break}${_orange}No builds performed, skipping export step${_reset}${_break}"
    fi
}

# Proton-TKG installation
__proton_install() {
    # Inform user about external configuration usage
    __msg_pkg "Proton-TKG" "${_frog_repo_url}/wine-tkg-git"

    # Optional DXVK/vkd3d preparation (user can skip with default option)
    __dxvk_tools_prepare || __msg_warning "dxvk-tools preparation cancelled or failed, continuing with Proton-TKG build${_break}"

    # Determine build command
    local _build_command="./proton-tkg.sh"
    local _clean_command="./proton-tkg.sh clean"

    # Build and install
    __install_package "${_pkg_repo[proton]}" "Proton-TKG" "$_build_command" "${_pkg_workdir[proton]}"
    local _status=$?

    if [[ $_status -eq 0 ]]; then
        # Ask user if clean command should be executed
        __msg_prompt "Do you want to run ${_reset}${_gray}'./proton-tkg.sh clean'${_reset} after building Proton-TKG? [y/N]: "
        local _old_trap_int=""
        _old_trap_int=$(trap -p INT 2>/dev/null) || true
        trap 'return 130' INT
        read -r _user_answer || {
            eval "${_old_trap_int:-trap - INT}"
            return 130
        }
        # Restore previous trap
        if [[ -n "$_old_trap_int" ]]; then eval "$_old_trap_int"; else trap - INT; fi

        if [[ "${_user_answer,,}" =~ ^(y|yes)$ ]]; then
            __install_package "${_pkg_repo[proton]}" "Proton-TKG" "$_clean_command" "${_pkg_workdir[proton]}"
            local _clean_status=$?
            if [[ $_clean_status -eq 0 ]]; then
                __msg_info "${_break}${_green_neon}â–¶${_reset} ${_green_light}Cleaning completed successfully.${_reset}${_break}"
            else
                __msg_error "Cleaning failed (code: ${_clean_status}).${_break}"
            fi
        fi
    fi
}

# =============================================================================
# EDITOR MANAGEMENT FUNCTION
# =============================================================================

# Helper function to handle individual config file editing and downloading if missing
__error_config() {
    local _msg="$1"
    clear
    __banner "$_red"
    __msg_error "$_msg"
    __msg_prompt "Press any key to continue...${_break}"
    read -n 1 -s -r || true
    clear
}

# Text editor launcher
__editor() {
    local _target_file="${1}"
    local _editor_parts=()

    # Parse $EDITOR variable and split into command + arguments
    if [[ -n "${EDITOR-}" ]]; then
        IFS=' ' read -r -a _editor_parts <<<"${EDITOR}" || true
    fi

    # Validate editor command exists, otherwise find fallback
    if [[ -z "${_editor_parts[0]:-}" ]] || ! command -v "${_editor_parts[0]}" >/dev/null 2>&1; then
        # Try common editors in order of preference
        for editor in nano micro vim vi; do
            if command -v "$editor" >/dev/null 2>&1; then
                _editor_parts=("$editor")
                break
            fi
        done

        # No editor found - show error
        if [[ -z "${_editor_parts[0]:-}" ]]; then
            __error_config "No editor found!${_break} Please set \$EDITOR environment variable or install one of:${_break} ${_gray}nano${_reset}, ${_gray}micro${_reset}, ${_gray}vim${_reset}, or ${_gray}vi${_reset}${_break}"
            return 1
        fi
    fi

    # Execute editor with target file
    "${_editor_parts[@]}" "$_target_file"
}

# AMD Graphics Driver submenu
__menu_amd() {
    clear
    # Define AMD menu options
    local _amd_menu_options=(
        "AMDGPU-PRO |ðŸ’Ž ${_green_neon}AMDGPU-PRO   ${_gray} AMD Vulkan-only graphics driver (Pro)"
        "AMDVLK-OPT |ðŸ”· ${_green_neon}AMDVLK-OPT   ${_gray} AMD standalone Vulkan driver (buildfromsource)"
        "return     |âª ${_green_neon}Return"
    )

    local _amd_menu_content
    _amd_menu_content=$(printf '%s\n' "${_amd_menu_options[@]}")

    # Define preview repositories for AMD submenu
    declare -A _amd_preview_repos=(
        [AMDGPU - PRO]="amdgpu-pro-vulkan-only/master"
        [AMDVLK - OPT]="amdvlk-opt/master"
    )

    # Export preview repos for subshell
    local _amd_repos_json
    _amd_repos_json=$(
        printf '%s\n' \
            "AMDGPU-PRO=${_amd_preview_repos[AMDGPU - PRO]}" \
            "AMDVLK-OPT=${_amd_preview_repos[AMDVLK - OPT]}"
    )
    export _amd_repos_json

    # Define preview command for AMD submenu
    # shellcheck disable=SC2016 # Need to use single quotes for fzf preview
    local _amd_preview_command='
        key=$(echo {} | cut -d"|" -f1 | xargs)
        [[ "$key" == "return" ]] && { echo "Back to main menu..."; exit 0; }
        
        repo=$(echo "$_amd_repos_json" | grep "^${key}=" | cut -d= -f2-)
        [[ -n "$repo" ]] && glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_frog_raw_url}"'/${repo}/README.md"
    '

    # Define header and footer for AMD submenu
    local _header_text="ðŸ¸ ${_green_neon}${_uline_on}TKG-Installer â”€ AMD Graphics Drivers${_uline_off}${_reset}${_break}${_break}\
${_green_light}    Select an AMD graphics driver to build and install:${_break}${_break}\
${_green_light}    Press [Ctrl+P] to toggle preview${_break}${_break}\
${_green_light}   Select an option below:"

    local _footer_text="  ${_green_light}Use arrow keys âŒ¨ï¸ or mouse ðŸ–±ï¸ to navigate${_break}\
  Press [Enter] to select, [Ctrl+P] to toggle preview, [ESC] to exit${_break}${_break}\
  ${_green_light}Website:${_reset} ${_gray}https://github.com/damachine/tkginstaller${_reset} | ${_gray}https://github.com/Frogging-Family"

    local _border_label_text="${_tkg_installer_version}"
    local _preview_window_settings='right:wrap:60%'
    local _fzf_bind='ctrl-p:toggle-preview'

    # Run fzf menu
    local _amd_choice
    _amd_choice=$(__fzf_menu "$_amd_menu_content" "$_amd_preview_command" "$_header_text" "$_footer_text" "$_border_label_text" "$_preview_window_settings" "$_fzf_bind")

    # Unset exported variables
    unset _amd_repos_json

    # Handle empty choice (ESC pressed)
    if [[ -z "$_amd_choice" ]]; then
        return 0
    fi

    # Extract driver key from choice
    _amd_choice=$(echo "$_amd_choice" | cut -d"|" -f1 | xargs)

    # Handle user choice from AMD submenu
    case $_amd_choice in
        AMDGPU-PRO)
            __banner
            __clear_line 120 ""
            __amdgpu_pro_install
            ;;
        AMDVLK-OPT)
            __banner
            __clear_line 120 ""
            __amdvlk_opt_install
            ;;
        return)
            return 0
            ;;
    esac
}

# Configuration file editor menu
__menu_config() {
    while true; do
        local _config_choice

        # Ensure configuration directory exists
        if [[ ! -d "${_local_config_dir}" ]]; then
            __banner "$_orange"
            __msg_warning "Configuration directory not found.${_break}"
            __msg_plain " Creating directory:${_reset}${_gray} ${_local_config_dir}${_reset}${_break}"
            __msg_prompt "Do you want to create the configuration directory? [y/N]: "

            local _old_trap_int=""
            _old_trap_int=$(trap -p INT 2>/dev/null) || true
            trap 'echo;echo; __msg_plain "${_red}Aborted by user.${_reset}";sleep 1.5; clear; return 0' INT
            __prompt_answer "n"
            if [[ -n "$_old_trap_int" ]]; then eval "$_old_trap_int"; else trap - INT; fi

            case "${_user_answer,,}" in
                y | yes)
                    if ! mkdir -p "${_local_config_dir}" 2>/dev/null; then
                        __error_config "Creating configuration directory failed: ${_local_config_dir}${_break} Please check the path and your permissions then try again.${_break}"
                        return 1
                    fi
                    clear
                    __banner
                    __msg_info "Configuration directory created:${_reset}${_gray} ${_local_config_dir}${_reset}${_break}"
                    __msg_plain " You can now manage your${_reset}${_gray} customization.cfg${_reset} files.${_break}"
                    __msg_prompt "Press any key to continue...${_break}"
                    read -n 1 -s -r || true
                    clear
                    continue
                    ;;
                *)
                    clear
                    __banner "$_orange"
                    __msg_info_orange "Directory creation cancelled.${_break}"
                    __msg_plain " No changes were made.${_break}"
                    __msg_prompt "Press any key to continue...${_break}"
                    read -n 1 -s -r || true
                    clear
                    return 0
                    ;;
            esac
        fi

        # Build menu options dynamically
        local _menu_options=(
            "linux  |ðŸ§ ${_green_neon}Linux   ${_gray} customization.cfg ${_reset}->${_orange} 'linux-tkg.cfg'  "
        )

        # Add Nvidia and Mesa options only for Arch-based distros
        if [[ "${_is_arch_based}" == "true" ]]; then
            _menu_options+=(
                "nvidia |ðŸ’» ${_green_neon}Nvidia  ${_gray} customization.cfg ${_reset}->${_orange} 'nvidia-all.cfg'"
                "mesa   |ðŸ§© ${_green_neon}Mesa    ${_gray} customization.cfg ${_reset}->${_orange} 'mesa-git.cfg'"
            )
        fi

        _menu_options+=(
            "wine   |ðŸ· ${_green_neon}Wine    ${_gray} customization.cfg ${_reset}->${_orange} 'wine-tkg.cfg'"
            "proton |ðŸŽ® ${_green_neon}Proton  ${_gray} customization.cfg ${_reset}->${_orange} 'proton-tkg.cfg'"
            "dxvk   |ðŸŽ® ${_green_neon}Dxvk    ${_gray} customization.cfg ${_reset}->${_orange} 'updxvk.cfg'"
            "vkd3d  |ðŸŽ® ${_green_neon}Vkd3d   ${_gray} customization.cfg ${_reset}->${_orange} 'upvkd3d-proton.cfg'"
            "return |âª ${_green_neon}Return"
        )

        # Prepare menu content
        local _menu_content
        _menu_content=$(printf '%s\n' "${_menu_options[@]}")

        # Export config URLs for preview command (build full URLs from global paths)
        local _pkg_urls_json
        _pkg_urls_json=$(
            printf '%s\n' \
                "linux=${_frog_raw_url}/${_pkg_config_path[linux]}" \
                "nvidia=${_frog_raw_url}/${_pkg_config_path[nvidia]}" \
                "mesa=${_frog_raw_url}/${_pkg_config_path[mesa]}" \
                "wine=${_frog_raw_url}/${_pkg_config_path[wine]}" \
                "proton=${_frog_raw_url}/${_pkg_config_path[proton]}" \
                "dxvk=${_frog_raw_url}/${_pkg_config_path[dxvk]}" \
                "vkd3d=${_frog_raw_url}/${_pkg_config_path[vkd3d]}"
        )
        export _pkg_urls_json

        # Export local config filenames for preview command
        local _pkg_local_cfg_json
        _pkg_local_cfg_json=$(
            printf '%s\n' \
                "linux=${_pkg_local_config[linux]}" \
                "nvidia=${_pkg_local_config[nvidia]}" \
                "mesa=${_pkg_local_config[mesa]}" \
                "wine=${_pkg_local_config[wine]}" \
                "proton=${_pkg_local_config[proton]}" \
                "dxvk=${_pkg_local_config[dxvk]}" \
                "vkd3d=${_pkg_local_config[vkd3d]}"
        )
        export _pkg_local_cfg_json

        # Define preview command components
        local _info_config="${_green_neon}Comparing remote and local ${_reset}${_gray}customization.cfg${_reset}${_green_neon}, press [Enter] to open and edit ${_reset}${_break}${_break}${_green_light} Remote:${_reset}${_gray} \$_remote_url ${_reset}${_break}${_orange}â‰ ${_reset}${_green_light} Local:${_reset}${_gray} file://\$_config_file_path ${_reset}${_break}${_green_dark}${_line}${_break}"

        # Define error message for missing config file
        local _error_config_not_exist="${_orange}No external configuration file found.${_reset}${_break}${_break}${_green_light} This configuration file is required for customizing the -TKG- package.${_break}${_green_light} Press [Enter] to download the missing${_reset}${_gray} customization.cfg${_reset}${_green_light} file, according to -TKG- package standards.${_reset}${_break}${_green_dark}${_line}${_break}"

        # Define bat and wdiff commands for preview
        local _bat_cmd="bat --style=plain --language=cfg --wrap character --terminal-width ${_cols} --force-colorization --theme='Visual Studio Dark+'"
        local _diff_cmd="wdiff --terminal --statistics --start-delete='${_red}' --end-delete='${_reset}' --start-insert='${_green_light}' --end-insert='${_reset}'"

        # Simplified preview command using exported URLs
        # shellcheck disable=SC2016 # Need to use single quotes for fzf preview
        local _preview_command='
            key=$(echo {} | cut -d"|" -f1 | xargs)

            [[ "$key" == "return" ]] && { glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_tkg_raw_url}"'/return.md"; exit 0; }

            _local_cfg_name=$(echo "$_pkg_local_cfg_json" | grep "^${key}=" | cut -d= -f2-)
            _config_file_path="'"${_local_config_dir}"'/${_local_cfg_name}"
            _remote_url=$(echo "$_pkg_urls_json" | grep "^${key}=" | cut -d= -f2-)

            if [[ -f "$_config_file_path" && -n "$_remote_url" ]]; then
                _remote_tmp="'"${_tkg_tmp_dir}"'/${key}-remote.cfg"
                if curl '"${_curl_opts}"' "$_remote_url" -o "$_remote_tmp" 2>/dev/null; then
                    printf "%b\n" "'"${_info_config}"'"
                    '"${_diff_cmd}"' "$_remote_tmp" "$_config_file_path" 2>/dev/null | '"${_bat_cmd}"' || printf "%b\n" "${_orange}Diff failed${_reset}"
                    rm -f "$_remote_tmp"
                else
                    printf "%b\n" "'"${_error_config_not_exist}"'"
                fi
            else
                printf "%b\n" "'"${_error_config_not_exist}"'"
            fi
        '

        # Define header texts
        local _header_text="ðŸ¸ ${_green_neon}${_uline_on}TKG-Installer â”€ Customizing (Beta)${_uline_off}${_reset}${_break}${_break}\
${_green_light}    - Customize to your preferred settings${_break}\
${_green_light}    - Download missing file(s)${_break}\
${_green_light}    - Show difference between remote and local${_break}${_break}\
${_green_light}    According to -TKG/Frogminer- package standards file(s)${_break}    stored in: ${_reset}${_gray}file://$HOME/.config/frogminer/${_reset}${_break}${_break}\
${_green_light}    Please make sure to adjust the settings correctly!${_break}    More visit: ${_reset}${_gray}https://github.com/Frogging-Family${_reset}${_break}${_break}${_break}\
${_green_light}   Select an option below:"

        # Define footer texts
        local _footer_text="  ${_green_light}Use arrow keys âŒ¨ï¸ or mouse ðŸ–±ï¸ to navigate${_break}\
  Press [Enter] to select, [Ctrl+P] ${_green_light}to toggle the preview window, [ESC] to exit${_break}${_break}\
  ${_green_light}Website:${_reset} ${_gray}https://github.com/damachine/tkginstaller${_reset} | ${_gray}https://github.com/Frogging-Family"

        # Define border label text
        local _border_label_text="${_tkg_installer_version}"
        local _preview_window_settings='right:wrap:75%'
        local _fzf_bind='ctrl-p:toggle-preview'

        # Run fzf menu
        local _config_choice
        _config_choice=$(__fzf_menu "$_menu_content" "$_preview_command" "$_header_text" "$_footer_text" "$_border_label_text" "$_preview_window_settings" "$_fzf_bind")

        # Unset exported var _pkg_local_cfg_jsoniables
        unset _pkg_urls_json

        # Handle empty choice (ESC pressed)
        if [[ -z "$_config_choice" ]]; then
            __banner
            __msg_info "${_green_neon}${_uline_on}APPLY${_uline_off}:${_reset}${_gray} customization.cfg${_reset}${_green_light} changes...${_break}"
            sleep 1.5s
            clear
            return 0
        fi

        # Extract config file key
        local _config_file
        _config_file=$(echo "${_config_choice}" | cut -d"|" -f1 | xargs)

        # Handle return option
        if [[ "$_config_file" == "return" ]]; then
            __banner
            __msg_info "${_green_neon}${_uline_on}APPLY${_uline_off}:${_reset}${_gray} customization.cfg${_reset}${_green_light} changes...${_break}"
            sleep 1.5s
            clear
            return 0
        fi

        # Handle config editing using global package mappings
        if [[ -n "${_pkg_config_path[$_config_file]:-}" ]]; then
            __handle_config \
                "${_pkg_display_name[$_config_file]}" \
                "${_local_config_dir}/${_pkg_local_config[$_config_file]}" \
                "$(__get_config_url "$_config_file")" || true
        fi
    done
}

# Helper function to detect deprecated config variables
__old_config() {
    local _config_file="$1"
    local _upstream_url="$2"
    local _package_name="$3"

    # Check if config file exists
    if [[ ! -f "$_config_file" ]]; then
        return 0
    fi

    # Download upstream config
    local _tmp_upstream="/tmp/upstream_customization.cfg"
    if ! curl -fsSL "$_upstream_url" -o "$_tmp_upstream" 2>/dev/null; then
        __msg_warning "Could not download upstream config for comparison"
        return 1
    fi

    # Extract variable names from local file
    local _local_vars
    _local_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_config_file" 2>/dev/null | sort -u || true)

    # Extract variable names from upstream file(s)
    local _upstream_vars
    _upstream_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_tmp_upstream" 2>/dev/null | sort -u || true)

    # For linux-tkg, also check _deprecated_config_vars from prepare file
    local _officially_deprecated=""
    if [[ "$_package_name" == "Linux-TKG" ]]; then
        local _prepare_url="${_frog_raw_url}/linux-tkg/master/linux-tkg-config/prepare"
        local _tmp_prepare="/tmp/linux-tkg-prepare"
        if curl -fsSL "$_prepare_url" -o "$_tmp_prepare" 2>/dev/null; then
            # Extract deprecated variables from _deprecated_config_vars array
            _officially_deprecated=$(sed -n '/_deprecated_config_vars=($/,/^)$/p' "$_tmp_prepare" | grep -oP '^\s*"_\K[^"]+' | sed 's/^/_/' || true)
            rm -f "$_tmp_prepare"
        fi
    fi

    # Check for advanced customization file variables for Wine-TKG and Proton-TKG
    if [[ "$_package_name" == "Wine-TKG" ]]; then
        # Check advanced-customization.cfg
        local _adv_url="${_frog_raw_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/wine-tkg-profiles/advanced-customization.cfg"
        local _tmp_adv="/tmp/upstream_advanced.cfg"
        if curl -fsSL "$_adv_url" -o "$_tmp_adv" 2>/dev/null; then
            local _adv_vars
            _adv_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_tmp_adv" 2>/dev/null || true)
            if [[ -n "$_adv_vars" ]]; then
                _upstream_vars=$(printf "%s\n%s" "$_upstream_vars" "$_adv_vars" | sort -u)
            fi
            rm -f "$_tmp_adv"
        fi
        # Check sample-external-config.cfg
        local _ext_url="${_frog_raw_url}/wine-tkg-git/refs/heads/master/wine-tkg-git/wine-tkg-profiles/sample-external-config.cfg"
        local _tmp_ext="/tmp/upstream_external.cfg"
        if curl -fsSL "$_ext_url" -o "$_tmp_ext" 2>/dev/null; then
            local _ext_vars
            _ext_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_tmp_ext" 2>/dev/null || true)
            if [[ -n "$_ext_vars" ]]; then
                _upstream_vars=$(printf "%s\n%s" "$_upstream_vars" "$_ext_vars" | sort -u)
            fi
            rm -f "$_tmp_ext"
        fi
    elif [[ "$_package_name" == "Proton-TKG" ]]; then
        # Check advanced-customization.cfg
        local _adv_url="${_frog_raw_url}/wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg-profiles/advanced-customization.cfg"
        local _tmp_adv="/tmp/upstream_advanced.cfg"
        if curl -fsSL "$_adv_url" -o "$_tmp_adv" 2>/dev/null; then
            local _adv_vars
            _adv_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_tmp_adv" 2>/dev/null || true)
            if [[ -n "$_adv_vars" ]]; then
                _upstream_vars=$(printf "%s\n%s" "$_upstream_vars" "$_adv_vars" | sort -u)
            fi
            rm -f "$_tmp_adv"
        fi
        # Check sample-external-config.cfg
        local _ext_url="${_frog_raw_url}/wine-tkg-git/refs/heads/master/proton-tkg/proton-tkg-profiles/sample-external-config.cfg"
        local _tmp_ext="/tmp/upstream_external.cfg"
        if curl -fsSL "$_ext_url" -o "$_tmp_ext" 2>/dev/null; then
            local _ext_vars
            _ext_vars=$(grep -oP '^[_a-zA-Z][_a-zA-Z0-9]*(?==)' "$_tmp_ext" 2>/dev/null || true)
            if [[ -n "$_ext_vars" ]]; then
                _upstream_vars=$(printf "%s\n%s" "$_upstream_vars" "$_ext_vars" | sort -u)
            fi
            rm -f "$_tmp_ext"
        fi
    fi

    # Find deprecated variables (in local but not in upstream)
    local _deprecated_vars
    _deprecated_vars=$(comm -23 <(echo "$_local_vars") <(echo "$_upstream_vars") 2>/dev/null || true)

    # Combine with officially deprecated variables for linux-tkg
    if [[ -n "$_officially_deprecated" ]]; then
        local _combined_deprecated
        _combined_deprecated=$(echo "$_local_vars" | grep -F -x -f <(echo "$_officially_deprecated") | sort -u || true)

        if [[ -n "$_combined_deprecated" ]]; then
            _deprecated_vars=$(printf "%s\n%s" "$_deprecated_vars" "$_combined_deprecated" | sort -u)
        fi
    fi

    # Notify user if deprecated variables found
    if [[ -n "$_deprecated_vars" ]]; then
        __banner "$_orange"
        __msg_warning "Found deprecated config variables in your local config:${_reset}${_gray} $_config_file ${_reset}${_break}"
        while IFS= read -r _var; do
            __msg_plain " ${_gray}${_var}${_reset}"
        done <<<"$_deprecated_vars"
        __msg_plain "${_break} These variables are no longer used in upstream.${_break} \
Please check this to ensure correctness! Then they can be removed from your local config.${_break}"
        __msg_prompt "Press any key to continue...${_break}"
        read -n 1 -s -r || true
    fi

    # Cleanup tmp upstream files
    rm -f "$_tmp_upstream"
}

# Helper function to handle individual config file editing and downloading if missing
__handle_config() {
    local _config_name="${1}"
    local _config_path="${2}"
    local _config_url="${3}"

    # Check for deprecated variables before editing
    if [[ -f "${_config_path}" ]]; then
        __old_config "${_config_path}" "${_config_url}" "${_config_name}"
        clear
    fi

    # Notify user
    __banner
    __msg_info "${_green_neon}${_uline_on}OPEN${_uline_off}:${_reset}${_gray} $_config_name${_reset}${_green_light} external configuration file${_break}"
    sleep 1.5s
    clear

    # Check if configuration file exists
    if [[ -f "${_config_path}" ]]; then
        # Edit existing configuration file
        __editor "${_config_path}" || {
            __msg_info "${_green_neon}${_uline_on}OPEN${_uline_off}:${_reset}${_gray} $_config_name${_reset}${_green_light} external configuration file${_break}"
            return 1
        }
    else
        # Download and create new configuration file
        __banner "$_orange"
        __msg_warning "External configuration file does not exist.${_break}"
        __msg_plain " Local path: ${_gray}file://${_config_path}"
        __msg_plain " Remote URL: ${_gray}${_config_url}${_break}"

        # Prompt user for download
        __msg_prompt "Do you want to download the default configuration? [y/N]: "

        local _old_trap_int=""
        _old_trap_int=$(trap -p INT 2>/dev/null) || true
        trap 'echo;echo; __msg_plain "${_red}Aborted by user.";sleep 1.5s; clear; return 0' INT
        __prompt_answer "n"
        if [[ -n "$_old_trap_int" ]]; then eval "$_old_trap_int"; else trap - INT; fi

        # Handle user response for downloading the config file
        case "${_user_answer,,}" in
            y | yes)
                # Create the configuration directory
                mkdir -p "$(dirname "${_config_path}")" || {
                    __error_config "Creating configuration directory failed: ${_config_path}${_break} Please check the path and your permissions then try again.${_break}"
                    return 1
                }

                # Check for curl availability
                if ! command -v curl >/dev/null 2>&1; then
                    __error_config "curl is not installed. Please install curl to download configuration files.${_break}"
                    return 1
                fi

                # Download config with timeout (project guideline)
                # shellcheck disable=SC2086 # _curl_opts must be unquoted for word splitting
                if curl ${_curl_opts} "${_config_url}" -o "${_config_path}" 2>/dev/null; then
                    clear
                    __banner
                    __msg_info "External configuration ready at:${_reset}${_gray} ${_config_path}"
                    sleep 1.5s
                    clear

                    # Open the downloaded configuration file
                    __editor "${_config_path}" || {
                        __error_config "Opening external configuration file:${_reset}${_gray} $_config_name${_break} Please check if the file exists and is accessible.${_break}"
                        return 1
                    }
                else
                    # Failed to download configuration file
                    __error_config "Downloading external configuration from ${_config_url} failed!${_break} Please check your internet connection and try again.${_break}"
                    return 1
                fi
                ;;
            *)
                # User chose not to download the configuration file
                clear
                __banner "$_orange"
                __msg_info_orange "Download cancelled. No configuration file created.${_break}"
                __msg_plain " No changes were made.${_break}"
                __msg_prompt "Press any key to continue...${_break}"
                read -n 1 -s -r || true
                clear
                return 1
                ;;
        esac
    fi

    # Notify user
    __banner
    __msg_info "${_green_neon}${_uline_on}CLOSE${_uline_off}:${_reset}${_gray} $_config_name${_reset}${_green_light} external configuration file${_break}"
    sleep 1.5s
    clear
    return 0
}

# =============================================================================
# FZF MAIN MENU FUNCTIONS
# =============================================================================

# Interactive main menu
__menu() {
    # Glow style detection
    if [[ -z "${_glow_style:-}" ]]; then
        case "${COLORTERM:-}${TERM:-}" in
            *light* | *xterm* | *rxvt* | *konsole*)
                _glow_style="light"
                ;;
            *)
                _glow_style="dark"
                ;;
        esac
    fi

    # Define menu options
    local _menu_options=(
        "Linux  |ðŸ§ ${_green_neon}Linux   ${_gray} Linux custom kernels for better desktop and gaming experience"
    )

    if [[ "${_is_arch_based}" == "true" ]]; then
        _menu_options+=(
            "Nvidia      |ðŸ’» ${_green_neon}Nvidia  ${_gray} Nvidia open-source or proprietary graphics drivers"
            "Mesa        |ðŸ§© ${_green_neon}Mesa    ${_gray} AMD and Intel open-source graphics driver"
            "AMD         |ðŸ’Ž ${_green_neon}AMD     ${_gray} AMDGPU-PRO and Vulkan drivers (Pro & OPT)"
        )
    fi

    _menu_options+=(
        "Wine   |ðŸ· ${_green_neon}Wine    ${_gray} Windows compatibility layer to run Windows apps on Linux"
        "Proton |ðŸŽ® ${_green_neon}Proton  ${_gray} Run Windows games on the Linux system via Steam"
        "Config |ðŸ”§ ${_green_neon}Config  ${_gray} Enter external configuration files menu (Expert)"
        "Clean  |ðŸ§¹ ${_green_neon}Clean   ${_gray} Removes all temporary files for a clean installation"
        "Help   |â“ ${_green_neon}Help    ${_gray} Displays help and usage information about TKG-Installer"
        "Close  |âŽ ${_green_neon}Close"
    )

    local _menu_content
    _menu_content=$(printf '%s\n' "${_menu_options[@]}")

    # Define preview mappings
    declare -A _preview_docs=(
        [Linux]="linux"
        [Nvidia]="nvidia"
        [Mesa]="mesa"
        [AMD]="amd"
        [Wine]="wine"
        [Proton]="proton"
        [Config]="config"
        [Clean]="clean"
        [Help]="help"
        [Close]="close"
    )

    declare -A _preview_repos=(
        [Linux]="linux-tkg/master"
        [Nvidia]="nvidia-all/master"
        [Mesa]="mesa-git/master"
        [Wine]="wine-tkg-git/master/wine-tkg-git"
        [Proton]="wine-tkg-git/master/proton-tkg"
    )

    # Export preview mappings for subshell
    local _preview_docs_json
    _preview_docs_json=$(
        printf '%s\n' \
            "Linux=${_preview_docs[Linux]}" \
            "Nvidia=${_preview_docs[Nvidia]}" \
            "Mesa=${_preview_docs[Mesa]}" \
            "AMD=${_preview_docs[AMD]}" \
            "Wine=${_preview_docs[Wine]}" \
            "Proton=${_preview_docs[Proton]}" \
            "Config=${_preview_docs[Config]}" \
            "Clean=${_preview_docs[Clean]}" \
            "Help=${_preview_docs[Help]}" \
            "Close=${_preview_docs[Close]}"
    )
    export _preview_docs_json

    # Define preview repositories
    local _preview_repos_json
    _preview_repos_json=$(
        printf '%s\n' \
            "Linux=${_preview_repos[Linux]}" \
            "Nvidia=${_preview_repos[Nvidia]}" \
            "Mesa=${_preview_repos[Mesa]}" \
            "Wine=${_preview_repos[Wine]}" \
            "Proton=${_preview_repos[Proton]}"
    )
    export _preview_repos_json

    # Simplified preview command using exported mappings
    # shellcheck disable=SC2016 # Need to use single quotes for fzf preview
    local _preview_command='
        key=$(echo {} | cut -d"|" -f1 | xargs)

        # Get doc path
        doc=$(echo "$_preview_docs_json" | grep "^${key}=" | cut -d= -f2-)

        # Show local doc
        [[ -n "$doc" ]] && glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_tkg_raw_url}"'/${doc}.md"

        # Show remote README if package has repo
        repo=$(echo "$_preview_repos_json" | grep "^${key}=" | cut -d= -f2-)
        [[ -n "$repo" ]] && glow --pager --width 80 --style "'"${_glow_style:-dark}"'" "'"${_frog_raw_url}"'/${repo}/README.md"
    '
    # Define header texts
    local _header_text="ðŸ¸ ${_green_neon}${_uline_on}TKG-Installer â”€ Main${_uline_off}${_reset}${_break}${_break}\
    ${_green_light}- Build, install and customize -TKG/Frogminer- packages${_break}\
${_green_light}    - Manual in the preview window on the right${_break}${_break}${_break}\
${_green_light}   Select an option below:"

    # Define footer texts
    local _footer_text="  ${_green_light}Use arrow keys âŒ¨ï¸ or mouse ðŸ–±ï¸ to navigate${_break}\
  Press [Enter] to select, [Ctrl+P] ${_green_light}to toggle the preview window, [ESC] to exit${_break}${_break}\
  ${_green_light}Website:${_reset} ${_gray}https://github.com/damachine/tkginstaller${_reset} | ${_gray}https://github.com/Frogging-Family${_reset}"

    # Define border label text
    local _border_label_text="${_tkg_installer_version}"
    local _preview_window_settings='right:wrap:55%'
    local _fzf_bind='ctrl-p:toggle-preview'

    # Run fzf menu
    local _main_choice
    _main_choice=$(__fzf_menu "$_menu_content" "$_preview_command" "$_header_text" "$_footer_text" "$_border_label_text" "$_preview_window_settings" "$_fzf_bind")

    # Cleanup exported variables
    unset _preview_docs_json _preview_repos_json

    # Handle user choice
    if [[ -z "${_main_choice:-}" ]]; then
        clear
        __exit 0
    fi

    # Write user choice to file
    echo "$_main_choice" | cut -d"|" -f1 | xargs >"$_tkg_choice_file"
}

# =============================================================================
# MAIN PROGRAM ENTRY POINT
# =============================================================================

# Handle direct command-line arguments
__main_direct_mode() {
    local _arg1="${1:-}"
    _arg1="${_arg1,,}"
    local _arg2="${2:-}"
    _arg2="${_arg2,,}"

    # Accept both [package] [config] and [config] [package] order for arguments
    local _package=""
    local _config_arg=""

    # Check for config argument using helper functions
    if __is_config_arg "$_arg1"; then
        _config_arg="$_arg1"
        _package=$(__normalize_package "$_arg2")
    elif __is_config_arg "$_arg2"; then
        _config_arg="$_arg2"
        _package=$(__normalize_package "$_arg1")
    fi

    # Allow only supported second-args (config/edit/customize)
    if [[ "$_arg1" =~ ^(linux|l|nvidia|n|mesa|m|wine|w|proton|p)$ ]] && [[ -n "$_arg2" ]] &&
        ! [[ "$_arg2" =~ ^(config|c|edit|e|customize|cu)$ ]]; then
        __banner "$_orange"
        __msg_warning "Invalid argument:${_reset}${_gray} ${_arg1:-} ${_arg2:-}${_reset}${_break}"
        __msg_plain " The argument is either invalid or incomplete."
        __msg_plain " All available arguments run:${_break}"
        __msg_plain "$0 help${_break}"
        trap - INT TERM EXIT HUP
        __clean || true
        exit 1
    fi

    # If user asked only "config" (no package) -> open interactive config menu
    if [[ -n "$_config_arg" && -z "$_package" ]]; then
        # Prepare environment and open config menu in interactive mode (with preview)
        trap - INT TERM EXIT HUP
        __prepare true
        clear
        __menu_config
        __clean || true
        exit 0
    fi

    # Handle config editing using centralized mappings
    if [[ -n "$_package" && -n "$_config_arg" ]]; then
        local _config_path="${_local_config_dir}/${_package}.cfg"
        local _config_url
        _config_url=$(__get_config_url "$_package")
        local _config_name="${_pkg_display_name[$_package]}"

        # Disable exit trap before editing config
        trap - INT TERM EXIT HUP

        # Handle config file editing directly
        __handle_config "$_config_name" "$_config_path" "$_config_url" || true

        # Display exit messages
        __banner
        __msg_plain "${_green_mint}Closed... Finish${_break}"

        # Clean exit
        __clean || true
        exit 0
    fi

    # Handle regular install commands
    case "$_arg1" in
        linux | l | --linux | -l)
            __prepare
            __linux_install
            ;;
        nvidia | n | --nvidia | -n)
            __prepare
            __nvidia_install
            ;;
        mesa | m | --mesa | -m)
            __prepare
            __mesa_install
            ;;
        amdgpu | ag | --amdgpu | -ag)
            __prepare
            __amdgpu_pro_install
            ;;
        amdvlk | av | --amdvlk | -av)
            __prepare
            __amdvlk_opt_install
            ;;
        wine | w | --wine | -w)
            __prepare
            __wine_install
            ;;
        proton | p | --proton | -p)
            __prepare
            __proton_install
            ;;
        dxvk | d | --dxvk | -d)
            __prepare
            __dxvk_tools_prepare
            ;;
        clean | --clean)
            __clean_temp_dir
            exit 0 >/dev/null 2>&1
            ;;
        help | h | --help | -h)
            # Handle help command
            ;;
        *)
            # Invalid argument handling and usage instructions display
            __banner "$_orange"
            __msg_warning "Invalid argument:${_reset}${_gray} ${1:-} ${2:-}${_reset}${_break}"
            __msg_plain " The argument is either invalid or incomplete."
            __msg_plain " All available arguments run:${_break}"
            __msg_plain "$0 help${_break}"

            # Disable exit trap before cleanup and exit to avoid duplicate cleanup messages on exit
            trap - INT TERM EXIT HUP
            __clean || true
            exit 1
            ;;
    esac
}

# Main function for interactive mode
__main_interactive_mode() {
    # Initialize dynamic preview content for fzf menus
    __prepare true
    clear
    __menu || {
        __banner "$_red"
        __msg_error "Failed to initialize fzf menu!"
        __msg_plain " Exiting..."
        trap - INT TERM EXIT HUP
        __clean || true
        exit 1
    }

    # Process user selection from menu
    local _user_choice=""
    if [[ -f "$_tkg_choice_file" ]]; then
        _user_choice=$(<"$_tkg_choice_file") || true
    fi

    # Handle empty choice (ESC/Ctrl-C pressed)
    if [[ -z "${_user_choice:-}" ]]; then
        clear
        __exit 0
    fi

    # Remove temporary choice file
    rm -f "$_tkg_choice_file" 2>&1 || true

    # Handle user choice from menu
    case $_user_choice in
        Linux | Nvidia | Mesa | AMD | Wine | Proton)
            # Display banner before installation from menu
            __banner
            __clear_line 120
            ;;&
        Linux)
            __linux_install
            ;;
        Nvidia)
            __nvidia_install
            ;;
        Mesa)
            __mesa_install
            ;;
        AMD)
            __menu_amd
            clear
            exec "$0"
            ;;
        Wine)
            __wine_install
            ;;
        Proton)
            __proton_install
            ;;
        Config)
            __menu_config
            clear
            exec "$0"
            ;;
        Help)
            # Remove exit trap
            trap - INT TERM EXIT HUP
            __help
            __clean || true
            exit 0
            ;;
        Clean)
            __clean_temp_dir
            exit 0 >/dev/null 2>&1
            ;;
        Close)
            exit 0
            ;;
    esac
}

# Main function handles command line arguments and menu interaction
__main() {
    if [[ $# -gt 0 ]]; then
        __main_direct_mode "$@"
    else
        __main_interactive_mode
    fi
}

# SCRIPT EXECUTION ENTRY POINT
__main "$@"
