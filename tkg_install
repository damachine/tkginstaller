#!/usr/bin/env bash

#
# üê∏ TKG Installer ‚Äì Optimiert
#
#

set -euo pipefail

# üé® Farben
[ -e "$HOME"/.tkg/.config/colors/colors ] && source "$HOME"/.tkg/.config/colors/colors

# üìå Pfade und Lockfile
LOCKFILE="/tmp/tkg_installer.lock"
SCRIPT_PATH="$(realpath "$0")"

# üîí Doppelte Ausf√ºhrung verhindern
if [[ -f $LOCKFILE ]]; then
    echo -e "${RED}${BOLD}‚ùå Skript l√§uft bereits. Beende...${RESET}"
    exit 1
fi
touch "$LOCKFILE"

# üßπ Aufr√§umen bei Abbruch oder Beenden
_on_exit() {
    local code=$?
    rm -f "$LOCKFILE"
    [[ $code -ne 0 ]] && echo -e "${BREAK}${RED}${BOLD} üéØ Skript abgebrochen üéØ${RESET}"
    #if pacman -Qq ccache &>/dev/null; then
    #    yay -Rns ccache --noconfirm
    #fi
    rm -rf /tmp/check_tkg "$HOME/.tkg/temp" /tmp/linux-tkg /tmp/makepkg 2>/dev/null || true
    echo -e "${GREEN} üßπ Aufr√§umen abgeschlossen.${RESET}"
    exit $code
}
trap _on_exit INT TERM EXIT HUP

# üßπ Temp-Verzeichnisse l√∂schen
_clean_tmp() {
    echo -e "${GREEN} üßπ Bereinige tempor√§re Dateien ...${RESET}"
    #if pacman -Qq ccache &>/dev/null; then
    #    yay -Rns ccache --noconfirm
    #fi
    sudo rm -rf /tmp/linux-tkg /tmp/makepkg 2>/dev/null || true
}

# üßº Vorbereitung
_pre() {
    for cmd in fzf yay paccache bleachbit fastfetch gcc git onefetch; do
        if ! command -v "$cmd" >/dev/null; then
            echo -e "${RED}${BOLD} ‚ùå $cmd ist nicht installiert! Bitte installiere es zuerst.${RESET}"
            return 1
        fi
    done

    fastfetch
    echo -e "${BLUE} üîÅ Starte üê∏ TKG Installer...${RESET}"
    echo -e "${BLUE} üîç Aktualisiere zuerst Arch Linux...${RESET}"
    yay -Syu
    sudo paccache -rk0
    sudo bleachbit --clean system.localizations || true
    rm -rf "$HOME/.tkg/temp" 2>/dev/null || true
    mkdir -p "$HOME/.tkg/temp"
}

# üì¶ Installationsfunktionen
_linux_install() {
    cd "$HOME/.tkg/temp"
    git clone https://github.com/Frogging-Family/linux-tkg.git || { echo "${RED}${BOLD} ‚ùå Fehler beim Klonen von: linux-tkg${RESET}"; return 1; }
    cd linux-tkg
    onefetch --no-color-palette --no-art || true
    makepkg -si
}

_nvidia_install() {
    cd "$HOME/.tkg/temp"
    git clone https://github.com/Frogging-Family/nvidia-all.git || { echo "${RED}${BOLD} ‚ùå Fehler beim Klonen von: nvidia-all${RESET}"; return 1; }
    cd nvidia-all
    onefetch --no-color-palette --no-art || true
    makepkg -si
}

_mesa_install() {
    cd "$HOME/.tkg/temp"
    git clone https://github.com/Frogging-Family/mesa-git.git || { echo "${RED}${BOLD} ‚ùå Fehler beim Klonen von: mesa-git${RESET}"; return 1; }
    cd mesa-git
    onefetch --no-color-palette --no-art || true
    makepkg -si
}

_wine_install() {
    cd "$HOME/.tkg/temp"
    git clone https://github.com/Frogging-Family/wine-tkg-git.git || { echo "${RED}${BOLD} ‚ùå Fehler beim Klonen von: wine-tkg-git${RESET}"; return 1; }
    cd wine-tkg-git/wine-tkg-git
    onefetch --no-color-palette --no-art || true
    makepkg -si
    sudo setcap cap_sys_nice+ep /opt/wine-tkg-git-opt/bin/wineserver
}

_proton_install() {
    yay -S ccache --noconfirm
    cd "$HOME/.tkg/temp"
    git clone https://github.com/Frogging-Family/wine-tkg-git.git || { echo "${RED}${BOLD} ‚ùå Fehler beim Klonen von: wine-tkg-git${RESET}"; return 1; }
    cd wine-tkg-git/proton-tkg
    onefetch --no-color-palette --no-art || true
    ./proton-tkg.sh
    ./proton-tkg.sh clean
    if pacman -Qq ccache &>/dev/null; then
        yay -Rns ccache --noconfirm
    fi
}

# üìã Aktionen pro Auswahl
_linux_promt()         { echo -e "${GREEN}${BREAKOPT} üß† Installiere Linux-tkg  üöÄ üöÄ üöÄ ‚è≥ ‚è≥ ‚è≥${BREAKOPT}${RESET}"; _linux_install; }
_nvidia_promt()        { echo -e "${GREEN}${BREAKOPT} üéÆ Installiere Nvidia-tkg  üöÄ üöÄ üöÄ ‚è≥ ‚è≥ ‚è≥${BREAKOPT}${RESET}"; _nvidia_install; }
_linuxnvidia_promt()   { _linux_promt; _nvidia_promt; }
_mesa_promt()          { echo -e "${GREEN}${BREAKOPT} üß© Installiere Mesa-tkg  üöÄ üöÄ üöÄ ‚è≥ ‚è≥ ‚è≥${BREAKOPT}${RESET}"; _mesa_install; }
_wine_promt()          { echo -e "${GREEN}${BREAKOPT} üç∑ Installiere Wine-tkg  üöÄ üöÄ üöÄ ‚è≥ ‚è≥ ‚è≥${BREAKOPT}${RESET}"; _wine_install; }
_proton_promt()        { echo -e "${GREEN}${BREAKOPT} üß™ Installiere Proton-tkg  üöÄ üöÄ üöÄ ‚è≥ ‚è≥ ‚è≥${BREAKOPT}${RESET}"; _proton_install; }

# ‚úÖ Abschlussanzeige
_show_done() {
    local status=$?
    echo -e "${BREAKOPT}"
    echo -e "${BOLD} üìù Aktion abgeschlossen: $(date '+%Y-%m-%d %H:%M:%S')${RESET}"
    if [ $status -eq 0 ]; then
        echo -e "${GREEN} ‚úÖ Status: Erfolgreich${RESET}"
    else
        echo -e "${RED}${BOLD} ‚ùå Status: Fehler (Code: $status)${RESET}"
    fi
    echo -e "${BREAKOPT}"
}

# üéõÔ∏è Men√º mit Vorschau
_menu() {
    local auswahl
    auswahl=$(
        printf "%b\n" \
            "Linux          |üß† Linux-TKG        ‚Äì Linux Kernel TKG-Konfiguration" \
            "Nvidia         |üéÆ Nvidia-TKG       ‚Äì Nvidia Open-Source oder propriet√§ren Grafiktreiber" \
            "Linux+Nvidia   |üíª Linux+Nvidia     - Kombipaket: Linux-TKG + Nvidia-TKG" \
            "Mesa           |üß© Mesa-TKG         ‚Äì Mesa Open-Source Grafiktreiber f√ºr AMD und Intel" \
            "Wine           |üç∑ Wine-TKG         ‚Äì Windows-Kompatibilit√§tsschicht" \
            "Proton         |üß™ Proton-TKG       ‚Äì Windows-Kompatibilit√§tsschicht f√ºr Steam / Gaming" \
            "Clean          |üßπ Reset" \
            "Exit           |‚ùå Beenden" \
            | fzf --prompt="‚ùØ W√§hle eine Option: " \
                  --header="üéõÔ∏è TKG Frogminer Installation ‚Äì W√§hle ein Paket ..." \
                  --height="30" \
                  --border \
                  --ansi \
                  --delimiter="|" \
                  --with-nth="2" \
                  --preview='bash -c "
                             key=$(echo {} | cut -d"|" -f1 | xargs)
                             case \$key in
                             Wine)              cat \"$HOME/.tkg/.config/preview/wine.txt\" ;;
                             Proton)            cat \"$HOME/.tkg/.config/preview/proton.txt\" ;;
                             Mesa)              cat \"$HOME/.tkg/.config/preview/mesa.txt\" ;;
                             Nvidia)            cat \"$HOME/.tkg/.config/preview/nvidia.txt\" ;;
                             Linux)             cat \"$HOME/.tkg/.config/preview/kernel.txt\" ;;
                             Linux+Nvidia)      cat \"$HOME/.tkg/.config/preview/linux.txt\" ;;
                             Clean)             cat \"$HOME/.tkg/.config/preview/clean.txt\" ;;
                             Exit)              echo \"üëã Auf Wiedersehen!\" ;;
                             esac
                            "' \
                  --preview-window="down:wrap:15" \
                  --color="header:italic:underline,prompt:italic:green,pointer:green,marker:red" \
                  --pointer="‚û§ "
    )

    # Bei ESC oder Abbruch
    if [[ -z "$auswahl" ]]; then
        echo -e " ${RED}${BOLD}‚ùå Auswahl abgebrochen.${RESET}"
        _on_exit
    fi

    # Auswahl speichern
    echo "$auswahl" | cut -d"|" -f1 | xargs > /tmp/check_tkg
}

# ‚ñ∂Ô∏è Hauptfunktion
_main() {
    _pre
    clear
    _menu

    choice=$(< /tmp/check_tkg)
    rm -f /tmp/check_tkg

    case $choice in
        Linux+Nvidia)  _linuxnvidia_promt ;;
        Linux)         _linux_promt ;;
        Nvidia)        _nvidia_promt ;;
        Mesa)          _mesa_promt ;;
        Wine)          _wine_promt ;;
        Proton)        _proton_promt ;;
        Clean)         _pre; sleep 1; echo -e "${BLUE} üîÅ Starte üê∏ TKG Installer neu ...${RESET}"; sleep 1; rm -f "$LOCKFILE"; exec sudo -u damachine sh -c "$SCRIPT_PATH" ;;
        Exit)          echo -e "${BLUE} üëã Tsch√ºss!${RESET}"; exit 0 ;;
        *)             echo -e "${GREEN}${BOLD} ‚ùå Ung√ºltige Option: $choice${RESET}" ;;
    esac

    _show_done
}

_main
